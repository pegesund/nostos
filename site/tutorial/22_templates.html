<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Templates & Metaprogramming - Nostos Tutorial</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        .hljs-operator {
            color: #e06c75;
        }
        .hljs-function {
            color: #e5c07b;
        }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nostos: {
                            dark: '#0f172a',
                            primary: '#3b82f6',
                            accent: '#10b981',
                            code: '#1e293b'
                        }
                    },
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        html, body { max-width: 100vw; overflow-x: hidden; }
        pre { max-width: 100%; overflow-x: auto; white-space: pre; }
        code { word-break: break-word; }
        p, li, h1, h2, h3, h4 { word-wrap: break-word; overflow-wrap: break-word; }
        .prose { max-width: 100%; }
        article, main, .content { max-width: 100%; overflow-x: hidden; }
        * { box-sizing: border-box; }
        @media (max-width: 768px) {
            .flex-1 { min-width: 0; }
            pre { font-size: 12px; }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans antialiased overflow-x-hidden">

    <!-- Navbar -->
    <nav class="border-b border-slate-800 bg-slate-900/80 backdrop-blur fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <button id="mobile-menu-btn" class="md:hidden text-slate-300 hover:text-white mr-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <a href="../index.html" class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">Nostos</a>
                    <span class="ml-4 text-slate-400 border-l border-slate-700 pl-4 text-sm font-medium hidden sm:inline">Tutorial</span>
                </div>
                <div class="hidden md:flex space-x-6">
                    <a href="../index.html" class="text-slate-400 hover:text-white transition">Home</a>
                    <a href="https://github.com/pegesund/nostos" class="text-slate-400 hover:text-white transition">GitHub</a>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden border-t border-slate-800 bg-slate-900">
            <div class="px-4 py-3 space-y-2">
                <a href="../index.html" class="block text-slate-300 hover:text-white transition py-2">Home</a>
                <a href="https://github.com/pegesund/nostos" class="block text-slate-300 hover:text-white transition py-2">GitHub</a>
                <div class="border-t border-slate-700 pt-3 mt-3">
                    <div class="text-xs text-slate-500 uppercase font-semibold mb-2">Chapters</div>
                    <div id="mobile-chapters"></div>
                </div>
            </div>
        </div>
    </nav>
    <script>
        document.getElementById('mobile-menu-btn').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });
    </script>

    <div class="pt-16 flex min-h-screen">

        <!-- Sidebar -->
        <aside id="tutorial-sidebar" class="w-64 fixed top-16 h-[calc(100vh-4rem)] border-r border-slate-800 bg-slate-900 overflow-y-auto hidden md:block pb-8">
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-64 p-8 max-w-4xl">
            <div class="mb-12">
                <h1 class="text-4xl font-bold text-white mb-6">Templates & Metaprogramming</h1>
                <p class="text-lg text-slate-400 leading-relaxed mb-8">
                    Nostos provides a compile-time metaprogramming system based on templates. This tutorial walks through progressively more complex examples.
                </p>

                <!-- Core Concepts -->
                <h2 class="text-2xl font-semibold text-white mb-4">Core Concepts</h2>
                <div class="bg-slate-800/50 rounded-lg p-6 mb-8 border border-slate-700">
                    <ol class="text-slate-400 space-y-2 list-decimal list-inside">
                        <li><code class="text-blue-400">quote { expr }</code> - Capture code as AST data</li>
                        <li><code class="text-blue-400">~expr</code> - Splice: insert AST values</li>
                        <li><code class="text-blue-400">template name(params) = ...</code> - Compile-time functions</li>
                    </ol>
                </div>

                <!-- Example 1 -->
                <h2 class="text-2xl font-semibold text-white mb-4">Example 1: Simple Function Wrapper</h2>
                <p class="text-slate-400 mb-4">The most basic use - wrap a function body with extra behavior:</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-4 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos">template double(fn) = quote {
    result = ~fn.body
    result * 2
}

@double
getValue() = 21

main() = getValue()  # Returns 42</code></pre>
                </div>
                <p class="text-slate-400 mb-8">The decorator receives the full function and uses <code class="text-emerald-400">~fn.body</code> to splice in the original body.</p>

                <!-- Example 2 -->
                <h2 class="text-2xl font-semibold text-white mb-4">Example 2: Accessing Function Metadata</h2>
                <p class="text-slate-400 mb-4">Templates can inspect function name, parameters, and return type:</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-4 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos">template debugCall(fn) = quote {
    println("Calling: " ++ ~fn.name)
    result = ~fn.body
    println("Done: " ++ ~fn.name)
    result
}

@debugCall
add(a: Int, b: Int) = a + b

main() = add(1, 2)
# Output:
# Calling: add
# Done: add
# 3</code></pre>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-4 mb-8 border border-slate-700">
                    <h4 class="text-sm font-semibold text-slate-300 mb-2">Available fields:</h4>
                    <ul class="text-slate-400 text-sm space-y-1">
                        <li><code class="text-emerald-400">~fn.name</code> - Function name as String</li>
                        <li><code class="text-emerald-400">~fn.params</code> - List of {name, type} records</li>
                        <li><code class="text-emerald-400">~fn.body</code> - Function body AST</li>
                        <li><code class="text-emerald-400">~fn.returnType</code> - Return type as String</li>
                    </ul>
                </div>

                <!-- Example 3 -->
                <h2 class="text-2xl font-semibold text-white mb-4">Example 3: Memoized Fibonacci with MVar Cache</h2>
                <p class="text-slate-400 mb-4">A practical example using an mvar Map to cache computed Fibonacci values:</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-4 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos"># Fibonacci with mvar cache - demonstrates memoization pattern

mvar cache: Map[Int, Int] = %{}

# Cached fibonacci using mvar.update for atomic cache operations
fib(n: Int) -> Int = {
    if n < 2 {
        n
    } else {
        if cache.contains(n) {
            cache.get(n)
        } else {
            result = fib(n - 1) + fib(n - 2)
            cache.update(c => Map.insert(c, n, result))
            result
        }
    }
}

main() = {
    # With caching, fib(40) is instant (vs hours without)
    println("fib(40) = " ++ show(fib(40)))
}
# Output: fib(40) = 102334155</code></pre>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-4 mb-8 border border-slate-700">
                    <h4 class="text-sm font-semibold text-slate-300 mb-2">Key points:</h4>
                    <ul class="text-slate-400 text-sm space-y-1">
                        <li>• <code class="text-emerald-400">mvar cache: Map[Int, Int] = %{}</code> - Thread-safe mutable cache</li>
                        <li>• <code class="text-emerald-400">cache.contains(n)</code> - UFC style: check if value is cached</li>
                        <li>• <code class="text-emerald-400">cache.update(c => ...)</code> - Atomic read-modify-write</li>
                    </ul>
                </div>

                <!-- Example 4 -->
                <h2 class="text-2xl font-semibold text-white mb-4">Example 4: Type Decorator with Getter Generation</h2>
                <p class="text-slate-400 mb-4">Generate accessor functions for all fields of a type:</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-4 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos">template withGetters(typeDef) = quote {
    ~typeDef
    ~typeDef.fields[0].fields.map(f =>
        eval("get_" ++ f.name ++ "(r: " ++ ~typeDef.name ++ ") = r." ++ f.name)
    )
}

@withGetters
type Point = Point { x: Int, y: Int }

main() = {
    p = Point(x: 10, y: 20)
    get_x(p) + get_y(p)  # 30
}</code></pre>
                </div>
                <p class="text-slate-400 mb-8">This generates <code>get_x(r: Point) = r.x</code> and <code>get_y(r: Point) = r.y</code>.</p>

                <!-- Example 5 -->
                <h2 class="text-2xl font-semibold text-white mb-4">Example 5: Builder Pattern with Setters</h2>
                <p class="text-slate-400 mb-4">Generate both getters and setters:</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos">template withAccessors(typeDef) = quote {
    ~typeDef
    # Generate getters
    ~typeDef.fields[0].fields.map(f =>
        eval("get_" ++ f.name ++ "(r: " ++ ~typeDef.name ++ ") = r." ++ f.name)
    )
    # Generate setters (return new instance)
    ~typeDef.fields[0].fields.map(f =>
        eval("set_" ++ f.name ++ "(r: " ++ ~typeDef.name ++ ", v: " ++ f.type ++ ") = " ++
             ~typeDef.name ++ "(" ++ f.name ++ ": v)")
    )
}

@withAccessors
type Config = Config { timeout: Int, retries: Int }

main() = {
    c = Config(timeout: 30, retries: 3)
    c2 = set_timeout(c, 60)
    get_timeout(c2)  # 60
}</code></pre>
                </div>

                <!-- Example 6 -->
                <h2 class="text-2xl font-semibold text-white mb-4">Example 6: Compile-Time Feature Flags</h2>
                <p class="text-slate-400 mb-4">Use templates to enable/disable features at compile time:</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-4 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos"># Compile-time check - generates different code based on flag
template featureFlag(fn, enabled, errorMsg) = quote {
    ~if ~enabled {
        quote { ~fn.body }
    } else {
        quote { panic(~errorMsg) }
    }
}

@featureFlag(true, "Beta feature disabled")
betaFeature() = "Beta feature is active!"

@featureFlag(false, "Experimental feature disabled")
experimentalFeature() = "Never runs"

main() = betaFeature()  # Works: "Beta feature is active!"
# experimentalFeature() would panic: "Experimental feature disabled"</code></pre>
                </div>
                <p class="text-slate-400 mb-8">This pattern is useful for feature flags, debug-only code paths, and platform-specific implementations.</p>

                <!-- Example 7 -->
                <h2 class="text-2xl font-semibold text-white mb-4">Example 7: Runtime Parameter Validation with toVar</h2>
                <p class="text-slate-400 mb-4">Use <code class="text-emerald-400">toVar</code> to convert a parameter name string into a variable reference:</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-4 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos"># toVar converts fn.params[0].name (String) to a variable reference
template nonNegative(fn) = quote {
    if ~toVar(fn.params[0].name) < 0 {
        panic("Value must be non-negative")
    }
    ~fn.body
}

@nonNegative
mySqrt(n: Int) = n * n

main() = {
    mySqrt(4)    # Returns 16
    # mySqrt(-5) # Would panic: "Value must be non-negative"
}</code></pre>
                </div>
                <p class="text-slate-400 mb-8">The <code class="text-emerald-400">toVar</code> function takes a String and returns a Var AST node, allowing you to reference variables dynamically in generated code.</p>

                <!-- Example 8 -->
                <h2 class="text-2xl font-semibold text-white mb-4">Example 8: Unique Variable Names with Gensym</h2>
                <p class="text-slate-400 mb-4">Use gensym to avoid naming collisions in generated code:</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-4 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos">template withTempVar(typeDef) = quote {
    ~typeDef
    ~eval(~gensym("temp") ++ "_helper() = 42")
}

@withTempVar
type A = A {}

@withTempVar
type B = B {}

# Generates: temp_0_helper() and temp_1_helper()
# No naming collision!</code></pre>
                </div>
                <p class="text-slate-400 mb-8">Each call to <code class="text-emerald-400">gensym</code> produces a unique string like "prefix_0", "prefix_1", etc.</p>

                <!-- Example 9 -->
                <h2 class="text-2xl font-semibold text-white mb-4">Example 9: Compile-Time Code Execution</h2>
                <p class="text-slate-400 mb-4">Use <code class="text-emerald-400">comptime</code> to execute arbitrary Nostos code at compile time. Two syntaxes are supported:</p>

                <h3 class="text-lg font-semibold text-white mb-3">String syntax: <code class="text-emerald-400">comptime("code")</code></h3>
                <div class="bg-nostos-code rounded-lg p-6 mb-4 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos">template withComputedDefault(fn, multiplier) = quote {
    # Compute at compile time: 21 * 2 = 42
    defaultValue = ~comptime("21 * " ++ ~multiplier)
    ~fn.body + defaultValue
}

@withComputedDefault("2")
getValue(x: Int) = x

main() = getValue(0)  # Returns 42</code></pre>
                </div>

                <h3 class="text-lg font-semibold text-white mb-3">Block syntax: <code class="text-emerald-400">comptime({ block })</code></h3>
                <div class="bg-nostos-code rounded-lg p-6 mb-4 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos">template computed(fn, useSquare) = quote {
    result = ~comptime({
        base = 10
        if ~useSquare {
            base * base
        } else {
            base * 2
        }
    })
    result
}

@computed(true)
getSquare() = 0

main() = getSquare()  # 10 * 10 = 100</code></pre>
                </div>

                <p class="text-slate-400 mb-4">The <code class="text-emerald-400">comptime</code> function:</p>
                <ul class="text-slate-400 mb-4 list-disc ml-6">
                    <li>String syntax: Takes a String that gets evaluated</li>
                    <li>Block syntax: Takes a block <code class="text-emerald-400">({ ... })</code> that gets serialized and evaluated</li>
                    <li>Executes the code at compile time</li>
                    <li>Splices the result into the template</li>
                </ul>
                <p class="text-slate-400 mb-8">This is useful for pre-computing values, lookup tables, or any computation that can be done once at compile time. <strong>Note:</strong> <code class="text-emerald-400">comptime</code> executes in a minimal environment without stdlib. Use it for basic arithmetic, string operations, and simple computations.</p>

                <!-- Type Introspection Reference -->
                <h2 class="text-2xl font-semibold text-white mb-4">Type Introspection Reference</h2>
                <p class="text-slate-400 mb-4">For type decorators:</p>
                <div class="bg-slate-800/50 rounded-lg p-6 mb-8 border border-slate-700">
                    <ul class="text-slate-400 space-y-2">
                        <li><code class="text-emerald-400">~typeDef.name</code> - Type name as String</li>
                        <li><code class="text-emerald-400">~typeDef.fields</code> - Constructors (for variants) or fields (for records)</li>
                        <li><code class="text-emerald-400">~typeDef.fields[0].fields</code> - Fields of first constructor</li>
                        <li><code class="text-emerald-400">~typeDef.typeParams</code> - Generic type parameters</li>
                    </ul>
                    <p class="text-slate-400 mt-4">Each field has:</p>
                    <ul class="text-slate-400 space-y-1">
                        <li><code class="text-emerald-400">f.name</code> - Field name</li>
                        <li><code class="text-emerald-400">f.type</code> - Field type as String</li>
                    </ul>
                </div>

                <!-- AST Types Reference -->
                <h2 class="text-2xl font-semibold text-white mb-4">AST Types Reference</h2>
                <div class="bg-slate-800/50 rounded-lg p-6 mb-8 border border-slate-700">
                    <h4 class="text-sm font-semibold text-slate-300 mb-2">Literals</h4>
                    <p class="text-slate-400 text-sm mb-4"><code>Int</code>, <code>Float</code>, <code>String</code>, <code>Bool</code>, <code>Char</code>, <code>Unit</code></p>

                    <h4 class="text-sm font-semibold text-slate-300 mb-2">Identifiers</h4>
                    <p class="text-slate-400 text-sm mb-4"><code>Var</code></p>

                    <h4 class="text-sm font-semibold text-slate-300 mb-2">Expressions</h4>
                    <p class="text-slate-400 text-sm mb-4"><code>BinOp</code>, <code>UnaryOp</code>, <code>Call</code>, <code>MethodCall</code>, <code>FieldAccess</code>, <code>Index</code>, <code>Lambda</code>, <code>Block</code>, <code>If</code>, <code>Match</code>, <code>Let</code></p>

                    <h4 class="text-sm font-semibold text-slate-300 mb-2">Collections</h4>
                    <p class="text-slate-400 text-sm mb-4"><code>List</code>, <code>Tuple</code>, <code>Record</code>, <code>Map</code></p>

                    <h4 class="text-sm font-semibold text-slate-300 mb-2">Patterns</h4>
                    <p class="text-slate-400 text-sm mb-4"><code>PatternWildcard</code>, <code>PatternVar</code>, <code>PatternLit</code>, <code>PatternTuple</code>, <code>PatternList</code>, <code>PatternConstructor</code></p>

                    <h4 class="text-sm font-semibold text-slate-300 mb-2">Definitions</h4>
                    <p class="text-slate-400 text-sm mb-4"><code>FnDef</code>, <code>TypeDef</code>, <code>TraitImpl</code>, <code>Items</code></p>

                    <h4 class="text-sm font-semibold text-slate-300 mb-2">Template-specific</h4>
                    <p class="text-slate-400 text-sm"><code>Splice</code></p>
                </div>

                <!-- Best Practices -->
                <h2 class="text-2xl font-semibold text-white mb-4">Best Practices</h2>
                <div class="bg-slate-800/50 rounded-lg p-6 mb-8 border border-slate-700">
                    <ol class="text-slate-400 space-y-2 list-decimal list-inside">
                        <li><strong>Start simple</strong> - Get basic templates working before adding complexity</li>
                        <li><strong>Test incrementally</strong> - Verify each generated function works</li>
                        <li><strong>Use meaningful names</strong> - <code>fn</code>, <code>typeDef</code> are conventional for decorators</li>
                        <li><strong>Document what's generated</strong> - Comment the expected output</li>
                        <li><strong>Handle edge cases</strong> - What if there are no fields? No parameters?</li>
                    </ol>
                </div>

                <!-- Navigation -->
                <div class="mt-12 pt-8 border-t border-slate-800 flex justify-between">
                    <a href="21_mutability.html" class="text-blue-400 hover:text-blue-300 transition">&larr; Previous: Mutability</a>
                    <a href="23_complete_web_app.html" class="text-blue-400 hover:text-blue-300 transition">Next: Complete Web App &rarr;</a>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="../js/nostos-highlight.js"></script>
    <script src="../js/tutorial-sidebar.js"></script>
    <script>hljs.highlightAll();</script>

</body>
</html>
