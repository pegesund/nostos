<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Async I/O & HTTP - Nostos Tutorial</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        .hljs-operator { color: #e06c75; }
        .hljs-function { color: #e5c07b; }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nostos: { dark: '#0f172a', primary: '#3b82f6', accent: '#10b981', code: '#1e293b' }
                    },
                    fontFamily: { mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'] }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-900 text-slate-200 font-sans antialiased">

    <nav class="border-b border-slate-800 bg-slate-900/80 backdrop-blur fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <a href="../index.html" class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">Nostos</a>
                    <span class="ml-4 text-slate-400 border-l border-slate-700 pl-4 text-sm font-medium">Tutorial</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-16 flex min-h-screen">

        <aside id="tutorial-sidebar" class="w-64 fixed top-16 h-[calc(100vh-4rem)] border-r border-slate-800 bg-slate-900 overflow-y-auto hidden md:block pb-8">
            <div class="p-6">
                <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-4">Contents</h3>
                <ul class="space-y-3">
                    <li><a href="01_basics.html" class="block text-slate-400 hover:text-white transition">1. Basics</a></li>
                    <li><a href="02_functions.html" class="block text-slate-400 hover:text-white transition">2. Functions</a></li>
                    <li><a href="03_pattern_matching.html" class="block text-slate-400 hover:text-white transition">3. Pattern Matching</a></li>
                    <li><a href="04_lists_tuples.html" class="block text-slate-400 hover:text-white transition">4. Lists & Tuples</a></li>
                    <li><a href="05_maps_sets.html" class="block text-slate-400 hover:text-white transition">5. Maps & Sets</a></li>
                    <li><a href="06_typed_arrays.html" class="block text-slate-400 hover:text-white transition">6. Typed Arrays</a></li>
                    <li><a href="07_type_system.html" class="block text-slate-400 hover:text-white transition">7. Type System</a></li>
                    <li><a href="08_traits.html" class="block text-slate-400 hover:text-white transition">8. Traits</a></li>
                    <li><a href="09_builtin_traits.html" class="block text-slate-400 hover:text-white transition">9. Builtin Traits</a></li>
                    <li><a href="10_trait_bounds.html" class="block text-slate-400 hover:text-white transition">10. Trait Bounds</a></li>
                    <li><a href="11_error_handling.html" class="block text-slate-400 hover:text-white transition">11. Error Handling</a></li>
                    <li><a href="12_modules.html" class="block text-slate-400 hover:text-white transition">12. Modules & Imports</a></li>
                    <li><a href="13_stdlib.html" class="block text-slate-400 hover:text-white transition">13. Standard Library</a></li>
                    <li><a href="14_json.html" class="block text-slate-400 hover:text-white transition">14. JSON</a></li>
                    <li><a href="15_concurrency.html" class="block text-slate-400 hover:text-white transition">15. Concurrency</a></li>
                    <li><a href="16_async_runtime.html" class="block text-slate-400 hover:text-white transition">16. Async Runtime</a></li>
                    <li><a href="17_async_io_http.html" class="block text-blue-400 font-medium">17. Async I/O & HTTP</a></li>
                    <li><a href="18_reflection.html" class="block text-slate-400 hover:text-white transition">18. Reflection & Eval</a></li>
                    <li><a href="19_debugging_profiling.html" class="block text-slate-400 hover:text-white transition">19. Debugging & Profiling</a></li>
                    <li><a href="20_html_templating.html" class="block text-slate-400 hover:text-white transition">20. HTML Templating</a></li>
                    <li><a href="21_mutability.html" class="block text-slate-400 hover:text-white transition">21. Mutability</a></li>
                    <li><a href="22_complete_web_app.html" class="block text-slate-400 hover:text-white transition">22. Complete Web App</a></li>
                </ul>
            </div>
        </aside>

        <main class="flex-1 md:ml-64 p-8 max-w-4xl">
            <div class="mb-12">
                <h1 class="text-4xl font-bold text-white mb-6">Asynchronous I/O & HTTP</h1>
                <p class="text-lg text-slate-400 leading-relaxed mb-8">
                    Nostos provides fully asynchronous I/O for network and file access. Write synchronous-looking code while the runtime handles concurrency transparently.
                </p>

                <!-- HTTP Client -->
                <h2 class="text-2xl font-semibold text-white mb-4">HTTP Client</h2>
                <p class="text-slate-400 mb-4">Make HTTP requests with the built-in <code>Http</code> module. Operations are non-blocking.</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos">main() = {
    try {
        resp = Http.get("https://httpbin.org/ip")
        println("Your IP: " ++ resp.body)
    } catch { e ->
        println("Error: " ++ e)
    }
}</code></pre>
                </div>

                <!-- HTTP Server -->
                <h2 class="text-2xl font-semibold text-white mb-4">HTTP Server</h2>
                <p class="text-slate-400 mb-4">Build web servers with <code>stdlib.server</code>. The <code>serve()</code> function spawns a lightweight process per request.</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos">use stdlib.server.{serve, respondText, respond404}

handle(req) = match req.path {
    "/" -> respondText(req, "Hello from Nostos!")
    "/echo" -> respondText(req, req.body)
    _ -> respond404(req)
}

main() = {
    println("Server: http://localhost:8080")
    serve(8080, handle)
}</code></pre>
                </div>

                <!-- Query Parameters -->
                <h2 class="text-2xl font-semibold text-white mb-4">Query Parameters</h2>
                <p class="text-slate-400 mb-4">Use <code>getParam()</code> to look up values in query params, cookies, form params, or headers.</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos">use stdlib.server.{serve, getParam, respondText, respond400}

handleSearch(req) = {
    query = getParam(req.queryParams, "q")
    limit = getParam(req.queryParams, "limit")

    if query == "" then respond400(req, "Missing 'q' parameter")
    else respondText(req, "Searching: " ++ query)
}

main() = serve(8080, handleSearch)</code></pre>
                </div>

                <!-- Form Handling -->
                <h2 class="text-2xl font-semibold text-white mb-4">Form Handling</h2>
                <p class="text-slate-400 mb-4">Process POST data with <code>req.formParams</code>. URL decoding is automatic.</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos">use stdlib.server.{serve, getParam, respondText, respond400, respond405}

handleSubmit(req) = {
    if req.method != "POST" then respond405(req)
    else {
        name = getParam(req.formParams, "name")
        email = getParam(req.formParams, "email")

        if name == "" then respond400(req, "Name required")
        else respondText(req, "Thanks, " ++ name ++ "!")
    }
}</code></pre>
                </div>

                <!-- Type-Safe Request Parsing -->
                <h2 class="text-2xl font-semibold text-white mb-4">Type-Safe Request Parsing</h2>
                <p class="text-slate-400 mb-4">Use <code>requestToType</code> to parse query and form parameters directly into typed records. Returns <code>Ok(record)</code> on success or <code>Err(message)</code> with details about missing or invalid fields.</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos">use stdlib.server.{serve, respondText, respond400}

type Result[T, E] = Ok(T) | Err(E)
type Option[T] = Some(T) | None

# Define your parameter type
type CreateUserParams = { name: String, age: Int, email: Option[String] }

handleCreateUser(req) = {
    # Sugar syntax: compiler infers "CreateUserParams" from type annotation
    result: Result[CreateUserParams, String] = req.toType()

    match result {
        Ok(params) -> {
            # params.name is String, params.age is Int
            # params.email is Option[String] (None if not provided)
            respondText(req, "Created user: " ++ params.name ++ ", age " ++ show(params.age))
        }
        Err(msg) -> respond400(req, msg)
    }
}

main() = serve(8080, handleCreateUser)</code></pre>
                </div>

                <div class="bg-emerald-900/30 border border-emerald-500/30 rounded-lg p-4 mb-8">
                    <p class="text-emerald-200"><strong>Supported field types:</strong></p>
                    <ul class="list-disc list-inside text-emerald-200 mt-2 space-y-1">
                        <li><code>String</code> - Used as-is from request</li>
                        <li><code>Int</code>, <code>Int32</code>, <code>Int64</code> - Parsed from string</li>
                        <li><code>Float</code>, <code>Float64</code> - Parsed from string</li>
                        <li><code>Bool</code> - Accepts "true"/"false", "1"/"0", "yes"/"no"</li>
                        <li><code>Option[T]</code> - Defaults to <code>None</code> if field is missing</li>
                    </ul>
                </div>

                <p class="text-slate-400 mb-4">Error messages include the field name and what went wrong:</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># Missing required field:
# Err("missing required field 'age'")

# Invalid type:
# Err("field 'age': expected Int, got 'not_a_number'")</code></pre>
                </div>

                <!-- Cookies -->
                <h2 class="text-2xl font-semibold text-white mb-4">Cookies</h2>
                <p class="text-slate-400 mb-4">Read cookies with <code>getParam(req.cookies, name)</code>. Set cookies with helper functions.</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos">use stdlib.server.{serve, getParam, respondText, respondTextWith, setCookieWithAge, clearCookie}

handleLogin(req) = {
    user = getParam(req.queryParams, "user")
    respondTextWith(req, "Welcome " ++ user, [setCookieWithAge("session", user, 3600)])
}

handleLogout(req) = respondTextWith(req, "Logged out", [clearCookie("session")])

handleProfile(req) = {
    session = getParam(req.cookies, "session")
    if session == "" then respondText(req, "Not logged in")
    else respondText(req, "Session: " ++ session)
}</code></pre>
                </div>

                <!-- HTML Templating -->
                <h2 class="text-2xl font-semibold text-white mb-4">HTML Templating</h2>
                <p class="text-slate-400 mb-4">Build type-safe HTML with <code>Html(...)</code>. Tags are scoped functions inside the constructor.</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos">use stdlib.html.{Html, render}
use stdlib.server.{serve, respondHtml}

userCard(name: String, email: String) = Html(
    el("div", [("class", "card")], [
        h3(name),
        p("Email: " ++ email)
    ])
)

handleHome(req) = {
    content = Html(div([
        h1("Welcome"),
        userCard("Alice", "alice@example.com"),
        userCard("Bob", "bob@example.com")
    ]))
    respondHtml(req, render(content))
}

main() = serve(8080, handleHome)</code></pre>
                </div>

                <!-- URL Routing -->
                <h2 class="text-2xl font-semibold text-white mb-4">URL Routing</h2>
                <p class="text-slate-400 mb-4">Use <code>Server.matchPath</code> to extract path parameters like <code>:id</code>.</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos">use stdlib.server.{serve, respondText, respond404}

route(req) = {
    path = req.path

    if path == "/" then respondText(req, "Home")
    else {
        params = Server.matchPath(path, "/users/:id")
        if length(params) == 1 then {
            (_, userId) = head(params)
            respondText(req, "User: " ++ userId)
        } else respond404(req)
    }
}

main() = serve(8080, route)</code></pre>
                </div>

                <!-- WebSockets -->
                <h2 class="text-2xl font-semibold text-white mb-4">WebSockets</h2>
                <p class="text-slate-400 mb-4">Handle WebSocket connections with <code>req.isWebSocket</code> and the WebSocket module.</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos">use stdlib.server.{serve, respondText}

echoLoop(ws) = {
    ok = try {
        msg = WebSocket.recv(ws)
        WebSocket.send(ws, "Echo: " ++ msg)
        true
    } catch { _ -> false }
    if ok then echoLoop(ws) else WebSocket.close(ws)
}

route(req) = {
    if req.isWebSocket then {
        ws = WebSocket.accept(req.id)
        echoLoop(ws)
    } else respondText(req, "WebSocket server at ws://localhost:8080/")
}

main() = serve(8080, route)</code></pre>
                </div>

                <!-- PostgreSQL with Connection Pool -->
                <h2 class="text-2xl font-semibold text-white mb-4">PostgreSQL with Connection Pool</h2>
                <p class="text-slate-400 mb-4">Use an mvar to create a simple connection pool. Get a connection for each request, return it when done.</p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos">use stdlib.server.{serve, getParam, respondText, respond400}

# Connection pool using mvar
mvar pool: List[Int] = []

getConn() = match pool {
    [] -> Pg.connect("host=localhost user=postgres password=postgres")
    [conn | rest] -> { pool = rest; conn }
}

releaseConn(conn) = { pool = conn :: pool }

# Handlers
listUsers(req) = {
    conn = getConn()
    rows = Pg.query(conn, "SELECT id, name FROM users", [])
    releaseConn(conn)
    respondText(req, show(rows))
}

createUser(req) = {
    name = getParam(req.formParams, "name")
    if name == "" then respond400(req, "name required")
    else {
        conn = getConn()
        Pg.execute(conn, "INSERT INTO users (name) VALUES ($1)", [name])
        releaseConn(conn)
        respondText(req, "Created: " ++ name)
    }
}

route(req) = match req.path {
    "/users" -> if req.method == "POST" then createUser(req) else listUsers(req)
    _ -> respondText(req, "GET/POST /users")
}

main() = serve(8080, route)</code></pre>
                </div>

                <div class="bg-blue-900/30 border border-blue-500/30 rounded-lg p-4 mb-8">
                    <p class="text-blue-200"><strong>stdlib.server API:</strong></p>
                    <ul class="list-disc list-inside text-blue-200 mt-2 space-y-1">
                        <li><code>serve(port, handler)</code> - Start server with spawn-per-request</li>
                        <li><code>getParam(params, key)</code> - Look up key in param list</li>
                        <li><code>req.toType()</code> - Parse request params to typed record (with type annotation)</li>
                        <li><code>respondText(req, body)</code> - Send text response</li>
                        <li><code>respondHtml(req, body)</code> - Send HTML response</li>
                        <li><code>respondJson(req, body)</code> - Send JSON response</li>
                        <li><code>respond400(req, msg)</code> - Bad Request</li>
                        <li><code>respond404(req)</code> - Not Found</li>
                        <li><code>redirect(req, url)</code> - 302 redirect</li>
                        <li><code>setCookieWithAge(name, value, seconds)</code> - Cookie header tuple</li>
                        <li><code>wsLoop(ws, handler)</code> - WebSocket message loop</li>
                    </ul>
                </div>

            </div>

            <div class="flex justify-between border-t border-slate-800 pt-8">
                <a href="16_async_runtime.html" class="flex items-center text-blue-400 hover:text-blue-300 font-medium transition">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m0 0h18"></path></svg>
                    Previous: Async Runtime
                </a>
                <a href="18_reflection.html" class="flex items-center text-blue-400 hover:text-blue-300 font-medium transition">
                    Next: Reflection & Eval
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m0 0h18"></path></svg>
                </a>
            </div>
        </main>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="../js/nostos-highlight.js"></script>
    <script src="../js/tutorial-sidebar.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>
