<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCP Sockets - Nostos Tutorial</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        .hljs-operator { color: #e06c75; }
        .hljs-function { color: #e5c07b; }
    </style>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nostos: { dark: '#0f172a', primary: '#3b82f6', accent: '#10b981', code: '#1e293b' }
                    },
                    fontFamily: { mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'] }
                }
            }
        }
    </script>

    

    <style>
        html, body { max-width: 100vw; overflow-x: hidden; }
        pre { max-width: 100%; overflow-x: auto; white-space: pre; }
        code { word-break: break-word; }
        p, li, h1, h2, h3, h4 { word-wrap: break-word; overflow-wrap: break-word; }
        .prose { max-width: 100%; }
        article, main, .content { max-width: 100%; overflow-x: hidden; }
        * { box-sizing: border-box; }
        @media (max-width: 768px) {
            .flex-1 { min-width: 0; }
            pre { font-size: 12px; }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans antialiased overflow-x-hidden">

    <nav class="border-b border-slate-800 bg-slate-900/80 backdrop-blur fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <button id="mobile-menu-btn" class="md:hidden text-slate-300 hover:text-white mr-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <a href="../index.html" class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">Nostos</a>
                    <span class="ml-4 text-slate-400 border-l border-slate-700 pl-4 text-sm font-medium">Tutorial</span>
                </div>
                <div class="hidden md:flex space-x-6">
                    <a href="../index.html" class="text-slate-400 hover:text-white transition">Home</a>
                    <a href="https://github.com/pegesund/nostos" class="text-slate-400 hover:text-white transition">GitHub</a>
                </div>
                
            </div>
        </div>
    </nav>
    
    
    
    
    
    
    
    </div>
    

    <div class="pt-16 flex min-h-screen">

        <!-- Sidebar -->
        <aside id="tutorial-sidebar" class="w-64 fixed top-16 h-[calc(100vh-4rem)] border-r border-slate-800 bg-slate-900 overflow-y-auto hidden md:block pb-8">
            <!-- Sidebar content generated by tutorial-sidebar.js -->
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-64 p-8 max-w-4xl">
            <div class="mb-12">
                <h1 class="text-4xl font-bold text-white mb-6">TCP Sockets</h1>
                <p class="text-lg text-slate-400 leading-relaxed mb-8">
                    Nostos provides low-level TCP socket support for building network applications. The <code class="text-blue-400">Tcp</code> module allows you to create both TCP clients and servers, giving you full control over network communication.
                </p>

                <!-- Overview -->
                <h2 class="text-2xl font-semibold text-white mb-4">Overview</h2>
                <p class="text-slate-400 mb-4">
                    The TCP module provides six core functions for socket operations:
                </p>
                <div class="bg-slate-800/50 rounded-lg p-4 mb-8 border border-slate-700">
                    <ul class="text-slate-400 space-y-2">
                        <li><code class="text-blue-400">Tcp.connect(host, port)</code> - Connect to a TCP server</li>
                        <li><code class="text-blue-400">Tcp.listen(port)</code> - Listen for incoming connections</li>
                        <li><code class="text-blue-400">Tcp.accept(listener)</code> - Accept an incoming connection</li>
                        <li><code class="text-blue-400">Tcp.read(socket, maxBytes)</code> - Read data from a socket</li>
                        <li><code class="text-blue-400">Tcp.write(socket, data)</code> - Write data to a socket</li>
                        <li><code class="text-blue-400">Tcp.close(handle)</code> - Close a socket or listener</li>
                    </ul>
                </div>

                <!-- TCP Client -->
                <h2 class="text-2xl font-semibold text-white mb-4">TCP Client</h2>
                <p class="text-slate-400 mb-4">
                    Creating a TCP client is straightforward. Connect to a server, send data, receive a response, and close the connection.
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos"># Simple TCP client
main() = {
    println("Connecting to server...")
    sock = Tcp.connect("localhost", 9999)
    println("Connected!")

    # Send a message
    message = "Hello from Nostos!"
    bytesWritten = Tcp.write(sock, message)
    println("Sent " ++ show(bytesWritten) ++ " bytes")

    # Read response (up to 1024 bytes)
    response = Tcp.read(sock, 1024)
    println("Received: " ++ response)

    # Clean up
    Tcp.close(sock)
    println("Connection closed")
}</code></pre>
                </div>

                <!-- TCP Server -->
                <h2 class="text-2xl font-semibold text-white mb-4">TCP Server</h2>
                <p class="text-slate-400 mb-4">
                    A TCP server listens on a port and accepts incoming connections. Each connection can be handled in its own process for concurrency.
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos"># Simple TCP echo server
handleClient(sock) = {
    println("Client connected")

    # Read data from client
    data = Tcp.read(sock, 1024)
    println("Received: " ++ data)

    # Echo it back with prefix
    Tcp.write(sock, "Echo: " ++ data)

    # Close client connection
    Tcp.close(sock)
    println("Client disconnected")
}

main() = {
    println("Starting server on port 9999...")
    listener = Tcp.listen(9999)
    println("Listening...")

    # Accept loop - handle one client at a time
    loop {
        client = Tcp.accept(listener)
        handleClient(client)
    }
}</code></pre>
                </div>

                <!-- Concurrent Server -->
                <h2 class="text-2xl font-semibold text-white mb-4">Concurrent Server</h2>
                <p class="text-slate-400 mb-4">
                    For handling multiple clients simultaneously, spawn a new process for each connection using Nostos's lightweight processes.
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos"># Concurrent TCP server - handles multiple clients
handleClient(sock) = {
    try {
        data = Tcp.read(sock, 4096)
        if data != "" then {
            Tcp.write(sock, "Echo: " ++ data)
        } else ()
    } catch { e ->
        println("Client error: " ++ e)
    }
    Tcp.close(sock)
}

main() = {
    listener = Tcp.listen(8080)
    println("Server listening on port 8080")

    # Accept loop - spawn process for each client
    loop {
        client = Tcp.accept(listener)
        spawn { handleClient(client) }
    }
}</code></pre>
                </div>

                <!-- Error Handling -->
                <h2 class="text-2xl font-semibold text-white mb-4">Error Handling</h2>
                <p class="text-slate-400 mb-4">
                    TCP operations can fail (connection refused, timeout, etc.). Use try/catch to handle errors gracefully.
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos">main() = {
    try {
        sock = Tcp.connect("localhost", 9999)
        Tcp.write(sock, "Hello")
        response = Tcp.read(sock, 1024)
        Tcp.close(sock)
        println("Response: " ++ response)
    } catch { e ->
        println("Connection failed: " ++ e)
    }
}</code></pre>
                </div>

                <!-- Chat Server Example -->
                <h2 class="text-2xl font-semibold text-white mb-4">Example: Simple Chat Server</h2>
                <p class="text-slate-400 mb-4">
                    Here's a more complete example showing a multi-client chat server using MVars to share state between client handlers.
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre style="max-width:100%;overflow-x:auto"><code class="language-nostos"># Simple chat server with shared client list
mvar clients: List[Int] = []

broadcast(message, senderSock) = {
    clientList = clients
    clientList.each(sock => {
        if sock != senderSock then {
            try { Tcp.write(sock, message) } catch { _ -> () }
        } else ()
    })
}

handleClient(sock) = {
    # Add to client list
    clients = clients ++ [sock]
    println("Client joined. Total clients: " ++ show(length(clients)))

    try {
        loop {
            data = Tcp.read(sock, 1024)
            if data == "" then throw("Client disconnected")
            else {
                println("Broadcasting: " ++ data)
                broadcast(data, sock)
            }
        }
    } catch { _ ->
        # Remove from client list
        clients = clients.filter(s => s != sock)
        Tcp.close(sock)
        println("Client left. Total clients: " ++ show(length(clients)))
    }
}

main() = {
    listener = Tcp.listen(5000)
    println("Chat server running on port 5000")

    loop {
        client = Tcp.accept(listener)
        spawn { handleClient(client) }
    }
}</code></pre>
                </div>

                <!-- API Reference -->
                <h2 class="text-2xl font-semibold text-white mb-4">API Reference</h2>
                <div class="bg-slate-800/50 rounded-lg p-4 mb-8 border border-slate-700">
                    <h4 class="text-sm font-semibold text-slate-300 mb-3">Tcp Module Functions</h4>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="text-left text-slate-400 border-b border-slate-700">
                                <th class="pb-2">Function</th>
                                <th class="pb-2">Signature</th>
                                <th class="pb-2">Description</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-400">
                            <tr class="border-b border-slate-700/50">
                                <td class="py-2"><code class="text-blue-400">Tcp.connect</code></td>
                                <td class="py-2">String -> Int -> Int</td>
                                <td class="py-2">Connect to host:port, returns socket handle</td>
                            </tr>
                            <tr class="border-b border-slate-700/50">
                                <td class="py-2"><code class="text-blue-400">Tcp.listen</code></td>
                                <td class="py-2">Int -> Int</td>
                                <td class="py-2">Listen on port, returns listener handle</td>
                            </tr>
                            <tr class="border-b border-slate-700/50">
                                <td class="py-2"><code class="text-blue-400">Tcp.accept</code></td>
                                <td class="py-2">Int -> Int</td>
                                <td class="py-2">Accept connection, returns socket handle</td>
                            </tr>
                            <tr class="border-b border-slate-700/50">
                                <td class="py-2"><code class="text-blue-400">Tcp.read</code></td>
                                <td class="py-2">Int -> Int -> String</td>
                                <td class="py-2">Read up to N bytes from socket</td>
                            </tr>
                            <tr class="border-b border-slate-700/50">
                                <td class="py-2"><code class="text-blue-400">Tcp.write</code></td>
                                <td class="py-2">Int -> String -> Int</td>
                                <td class="py-2">Write string to socket, returns bytes written</td>
                            </tr>
                            <tr>
                                <td class="py-2"><code class="text-blue-400">Tcp.close</code></td>
                                <td class="py-2">Int -> ()</td>
                                <td class="py-2">Close socket or listener</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Tips -->
                <h2 class="text-2xl font-semibold text-white mb-4">Tips</h2>
                <div class="bg-slate-800/50 rounded-lg p-4 mb-8 border border-slate-700">
                    <ul class="text-slate-400 space-y-2">
                        <li><strong class="text-slate-300">Always close sockets:</strong> Use try/catch with Tcp.close in the catch block to ensure cleanup.</li>
                        <li><strong class="text-slate-300">Handle empty reads:</strong> <code>Tcp.read</code> returns an empty string when the connection is closed by the peer.</li>
                        <li><strong class="text-slate-300">Spawn per client:</strong> For scalable servers, spawn a lightweight process for each connection.</li>
                        <li><strong class="text-slate-300">Use MVars for shared state:</strong> When multiple client handlers need to share data, use MVars for thread-safe access.</li>
                        <li><strong class="text-slate-300">Read in a loop:</strong> TCP is a stream protocol - data may arrive in chunks. Read in a loop until you have a complete message.</li>
                    </ul>
                </div>

                <!-- Navigation -->
                <div class="flex justify-between items-center pt-8 border-t border-slate-800">
                    <a href="29_selenium.html" class="flex items-center text-slate-400 hover:text-white transition">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Previous: Selenium WebDriver
                    </a>
                    <span class="text-slate-600">End of Tutorial</span>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="../js/tutorial-sidebar.js"></script>
    <script>
        // Simple Nostos syntax highlighting
        hljs.registerLanguage('nostos', function(hljs) {
            return {
                keywords: {
                    keyword: 'if then else match type trait impl where use pub let mvar loop spawn try catch throw derive reactive',
                    literal: 'true false',
                    built_in: 'println print show length head tail map filter fold Some None Ok Err'
                },
                contains: [
                    hljs.HASH_COMMENT_MODE,
                    hljs.QUOTE_STRING_MODE,
                    hljs.C_NUMBER_MODE,
                    {
                        className: 'function',
                        begin: /[a-z_][a-zA-Z0-9_]*\s*(?=\()/
                    },
                    {
                        className: 'type',
                        begin: /\b[A-Z][a-zA-Z0-9_]*\b/
                    },
                    {
                        className: 'operator',
                        begin: /[+\-*\/%=<>!&|:]+/
                    }
                ]
            };
        });
        hljs.highlightAll();
    </script>



</body>
</html>
