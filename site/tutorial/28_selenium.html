<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selenium WebDriver - Nostos Tutorial</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        .hljs-operator {
            color: #e06c75; /* A distinct red/orange for operators */
        }
        .hljs-function {
            color: #e5c07b; /* A distinct yellow/gold for functions */
        }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        nostos: {
                            dark: '#0f172a',
                            primary: '#3b82f6',
                            accent: '#10b981',
                            code: '#1e293b'
                        }
                    },
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-900 text-slate-200 font-sans antialiased">

    <!-- Navbar -->
    <nav class="border-b border-slate-800 bg-slate-900/80 backdrop-blur fixed w-full z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <a href="../index.html" class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">Nostos</a>
                    <span class="ml-4 text-slate-400 border-l border-slate-700 pl-4 text-sm font-medium">Tutorial</span>
                </div>
                <div class="flex space-x-6">
                    <a href="../index.html" class="text-slate-400 hover:text-white transition">Home</a>
                    <a href="https://github.com/yourusername/nostos" class="text-slate-400 hover:text-white transition">GitHub</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-16 flex min-h-screen">

        <!-- Sidebar -->
        <aside id="tutorial-sidebar" class="w-64 fixed top-16 h-[calc(100vh-4rem)] border-r border-slate-800 bg-slate-900 overflow-y-auto hidden md:block pb-8">
            <!-- Sidebar content generated by tutorial-sidebar.js -->
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-64 p-8 max-w-4xl">
            <div class="mb-12">
                <h1 class="text-4xl font-bold text-white mb-6">Selenium WebDriver</h1>
                <p class="text-lg text-slate-400 leading-relaxed mb-8">
                    Selenium WebDriver is a powerful tool for automating web browser interactions. Nostos provides built-in functions to control browsers through Selenium, making it easy to write end-to-end tests for your web applications, automate repetitive browser tasks, or scrape dynamic web content. In this chapter, you'll learn how to use Nostos to drive a web browser programmatically.
                </p>

                <!-- What is Selenium -->
                <h2 class="text-2xl font-semibold text-white mb-4">What is Selenium?</h2>
                <p class="text-slate-400 mb-4">
                    Selenium WebDriver is an industry-standard tool for browser automation. It allows you to:
                </p>
                <ul class="list-disc list-inside text-slate-400 mb-6 space-y-2">
                    <li>Open web pages in a real browser (Chrome, Firefox, etc.)</li>
                    <li>Find elements on the page using CSS selectors or other methods</li>
                    <li>Click buttons, fill forms, and interact with the page</li>
                    <li>Read text content from elements</li>
                    <li>Wait for elements to appear (useful for dynamic/JavaScript-heavy pages)</li>
                    <li>Take screenshots and verify page state</li>
                </ul>
                <p class="text-slate-400 mb-8">
                    Nostos integrates with Selenium through ChromeDriver, providing a simple, high-level API that lets you write browser automation scripts in pure Nostos code.
                </p>

                <!-- Prerequisites -->
                <h2 class="text-2xl font-semibold text-white mb-4">Prerequisites</h2>
                <p class="text-slate-400 mb-4">
                    Before you can use Selenium with Nostos, you need to set up ChromeDriver:
                </p>

                <h3 class="text-xl font-semibold text-white mb-3 mt-6">1. Install Chrome Browser</h3>
                <p class="text-slate-400 mb-4">
                    Make sure you have Google Chrome installed on your system. Selenium will use this browser for automation.
                </p>

                <h3 class="text-xl font-semibold text-white mb-3 mt-6">2. Download ChromeDriver</h3>
                <p class="text-slate-400 mb-4">
                    ChromeDriver is a separate executable that Selenium uses to communicate with Chrome. Download it from <a href="https://chromedriver.chromium.org/downloads" class="text-blue-400 hover:text-blue-300">chromedriver.chromium.org</a>. Make sure to download the version that matches your Chrome browser version.
                </p>
                <div class="bg-slate-800 rounded-lg p-4 mb-6 font-mono text-sm text-slate-300 overflow-x-auto">
<pre># Check your Chrome version (Help -> About Google Chrome)
# Download matching ChromeDriver and place it in your PATH

# On Linux/Mac:
chmod +x chromedriver
sudo mv chromedriver /usr/local/bin/

# On Windows:
# Add chromedriver.exe to a directory in your PATH</pre>
                </div>

                <h3 class="text-xl font-semibold text-white mb-3 mt-6">3. Start ChromeDriver</h3>
                <p class="text-slate-400 mb-4">
                    ChromeDriver runs as a local server that accepts commands from your Nostos scripts. Start it on port 4444:
                </p>
                <div class="bg-slate-800 rounded-lg p-4 mb-8 font-mono text-sm text-slate-300 overflow-x-auto">
<pre>chromedriver --port=4444</pre>
                </div>
                <p class="text-slate-400 mb-8">
                    Keep this running in a terminal while you run your Selenium tests. You'll see log output as browsers are opened and commands are executed.
                </p>

                <div class="bg-gradient-to-r from-blue-900/20 to-emerald-900/20 rounded-lg p-6 mb-8 border border-blue-800/30">
                    <h3 class="text-lg font-semibold text-white mb-3">Tip: Headless Mode</h3>
                    <p class="text-slate-400">
                        By default, Selenium opens a visible browser window. For CI/CD pipelines or servers without displays, you can run Chrome in headless mode (no visible window). ChromeDriver will automatically use headless mode when the <code class="bg-slate-800 px-1 rounded">DISPLAY</code> environment variable is not set.
                    </p>
                </div>

                <!-- The Selenium API -->
                <h2 class="text-2xl font-semibold text-white mb-4">The Selenium API</h2>
                <p class="text-slate-400 mb-4">
                    Nostos provides the following built-in Selenium functions. All functions are in the <code class="bg-slate-800 px-2 py-1 rounded">Selenium</code> namespace:
                </p>
                <div class="overflow-x-auto mb-8">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="py-3 px-4 text-white font-semibold">Function</th>
                                <th class="py-3 px-4 text-white font-semibold">Description</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-400">
                            <tr class="border-b border-slate-800">
                                <td class="py-3 px-4"><code class="text-blue-400">Selenium.connect(url)</code></td>
                                <td class="py-3 px-4">Connect to ChromeDriver at the given URL. Returns a driver handle.</td>
                            </tr>
                            <tr class="border-b border-slate-800">
                                <td class="py-3 px-4"><code class="text-blue-400">Selenium.goto(driver, url)</code></td>
                                <td class="py-3 px-4">Navigate the browser to the specified URL.</td>
                            </tr>
                            <tr class="border-b border-slate-800">
                                <td class="py-3 px-4"><code class="text-blue-400">Selenium.waitFor(driver, selector, timeout)</code></td>
                                <td class="py-3 px-4">Wait up to <code>timeout</code> milliseconds for an element matching the CSS selector to appear.</td>
                            </tr>
                            <tr class="border-b border-slate-800">
                                <td class="py-3 px-4"><code class="text-blue-400">Selenium.click(driver, selector)</code></td>
                                <td class="py-3 px-4">Click on the element matching the CSS selector.</td>
                            </tr>
                            <tr class="border-b border-slate-800">
                                <td class="py-3 px-4"><code class="text-blue-400">Selenium.text(driver, selector)</code></td>
                                <td class="py-3 px-4">Get the text content of the element matching the CSS selector.</td>
                            </tr>
                            <tr class="border-b border-slate-800">
                                <td class="py-3 px-4"><code class="text-blue-400">Selenium.type(driver, selector, text)</code></td>
                                <td class="py-3 px-4">Type text into an input element matching the CSS selector.</td>
                            </tr>
                            <tr>
                                <td class="py-3 px-4"><code class="text-blue-400">Selenium.close(driver)</code></td>
                                <td class="py-3 px-4">Close the browser and end the session.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Your First Selenium Script -->
                <h2 class="text-2xl font-semibold text-white mb-4">Your First Selenium Script</h2>
                <p class="text-slate-400 mb-4">
                    Let's start with a simple script that opens a web page and reads some text:
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># my_first_selenium.nos
# Run with: ./target/release/nostos my_first_selenium.nos

main() = {
    println("Starting Selenium test...")

    # Connect to ChromeDriver (must be running on port 4444)
    driver = Selenium.connect("http://localhost:4444")
    println("Connected to ChromeDriver!")

    # Navigate to a website
    Selenium.goto(driver, "https://example.com")
    println("Navigated to example.com")

    # Wait for the heading to appear (up to 5 seconds)
    Selenium.waitFor(driver, "h1", 5000)

    # Get the text of the heading
    heading = Selenium.text(driver, "h1")
    println("Page heading: " ++ heading)

    # Close the browser
    Selenium.close(driver)
    println("Done!")

    0
}</code></pre>
                </div>
                <p class="text-slate-400 mb-6">
                    Running this script will:
                </p>
                <ol class="list-decimal list-inside text-slate-400 mb-8 space-y-2">
                    <li>Open a Chrome browser window</li>
                    <li>Navigate to example.com</li>
                    <li>Wait for the <code class="bg-slate-800 px-1 rounded">&lt;h1&gt;</code> element to appear</li>
                    <li>Print the heading text ("Example Domain")</li>
                    <li>Close the browser</li>
                </ol>

                <!-- CSS Selectors -->
                <h2 class="text-2xl font-semibold text-white mb-4">Understanding CSS Selectors</h2>
                <p class="text-slate-400 mb-4">
                    Selenium uses CSS selectors to find elements on the page. Here are the most common patterns:
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># By tag name
Selenium.text(driver, "h1")              # First &lt;h1&gt; element

# By ID (use # prefix)
Selenium.click(driver, "#submit-button") # Element with id="submit-button"

# By class (use . prefix)
Selenium.text(driver, ".error-message")  # Element with class="error-message"

# By data attribute (very useful for testing!)
Selenium.click(driver, "[data-testid='login-btn']")

# Combining selectors
Selenium.text(driver, "div.container h2")  # &lt;h2&gt; inside div.container
Selenium.click(driver, "form#login button[type='submit']")

# By attribute
Selenium.type(driver, "input[name='email']", "user@example.com")</code></pre>
                </div>

                <div class="bg-gradient-to-r from-blue-900/20 to-emerald-900/20 rounded-lg p-6 mb-8 border border-blue-800/30">
                    <h3 class="text-lg font-semibold text-white mb-3">Best Practice: Use data-testid Attributes</h3>
                    <p class="text-slate-400 mb-4">
                        For robust tests, add <code class="bg-slate-800 px-1 rounded">data-testid</code> attributes to your HTML elements. This decouples your tests from styling and structure changes. Nostos provides convenient named parameters for this:
                    </p>
                    <div class="bg-nostos-code rounded-lg p-4 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># In your Nostos RWeb app - use dataTestid and dataAction parameters
button("Place Order", dataAction: "submit", dataTestid: "submit-order")
span("$99.99", dataTestid: "total-price")
div([...], dataTestid: "cart-items")</code></pre>
                    </div>
                    <div class="bg-nostos-code rounded-lg p-4 mt-4 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># In your Nostos test - select by data-testid
Selenium.click(driver, "[data-testid='submit-order']")
price = Selenium.text(driver, "[data-testid='total-price']")</code></pre>
                    </div>
                </div>

                <!-- Waiting for Elements -->
                <h2 class="text-2xl font-semibold text-white mb-4">Waiting for Elements</h2>
                <p class="text-slate-400 mb-4">
                    Modern web applications often load content dynamically with JavaScript. The <code class="bg-slate-800 px-2 py-1 rounded">Selenium.waitFor</code> function is crucial for handling this:
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># Wait up to 5 seconds for an element to appear
Selenium.waitFor(driver, "[data-testid='results']", 5000)

# Now it's safe to interact with the element
results = Selenium.text(driver, "[data-testid='results']")
println("Search results: " ++ results)</code></pre>
                </div>
                <p class="text-slate-400 mb-4">
                    The timeout is specified in milliseconds. If the element doesn't appear within the timeout, an error is raised.
                </p>
                <p class="text-slate-400 mb-8">
                    For elements that take time to update after an action (like clicking a button), you can also use the <code class="bg-slate-800 px-2 py-1 rounded">sleep</code> function for simple delays:
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># Click a button that triggers an AJAX update
Selenium.click(driver, "[data-testid='load-more']")

# Wait a bit for the update to complete
sleep(500)  # 500 milliseconds

# Now read the updated content
content = Selenium.text(driver, "[data-testid='item-list']")</code></pre>
                </div>

                <!-- Complete Test Example -->
                <h2 class="text-2xl font-semibold text-white mb-4">Complete Test Example: Counter App</h2>
                <p class="text-slate-400 mb-4">
                    Let's write a complete test for a simple counter web application. First, here's the counter app (using Nostos RWeb):
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-6 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># counter_app.nos - A simple counter web app
use stdlib.rweb
use stdlib.rhtml

reactive Counter = { value: Int }

session() = {
    counter = Counter(0)

    (
        # Render function
        () => RHtml(div([
            h1("Counter Demo"),
            component("display", () => RHtml(
                div([
                    span("Count: "),
                    span(show(counter.value))
                ], dataTestid: "count")
            )),
            div([
                button("-", dataAction: "decrement", dataTestid: "decrement"),
                button("+", dataAction: "increment", dataTestid: "increment"),
                button("Reset", dataAction: "reset", dataTestid: "reset")
            ])
        ])),

        # Action handler
        (action, params) => match action {
            "increment" -> { counter.value = counter.value + 1 }
            "decrement" -> { counter.value = counter.value - 1 }
            "reset" -> { counter.value = 0 }
            _ -> ()
        }
    )
}

main() = startRWeb(8095, "Counter Demo", session)</code></pre>
                </div>
                <p class="text-slate-400 mb-4">
                    Now let's write a comprehensive Selenium test for this counter:
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># counter_test.nos - Selenium tests for the counter app
#
# To run:
#   1. Start ChromeDriver: chromedriver --port=4444
#   2. Start the counter app: ./nostos counter_app.nos
#   3. Run the test: ./nostos counter_test.nos

# Helper function to run a test and report results
runTest(name, got, expected) = {
    println("Test: " ++ name)
    println("  Got: " ++ got)
    result = String.contains(got, expected)
    if result then println("  [PASS]") else println("  [FAIL] Expected: " ++ expected)
    if result then 1 else 0
}

main() = {
    println("=== Counter App Selenium Tests ===")
    println("")

    # Connect to ChromeDriver
    println("Connecting to ChromeDriver...")
    driver = Selenium.connect("http://localhost:4444")
    println("Connected!")

    # Navigate to the counter app
    println("Navigating to counter app...")
    Selenium.goto(driver, "http://localhost:8095")

    # Wait for the page to load
    Selenium.waitFor(driver, "[data-testid='count']", 5000)
    println("Page loaded!")
    println("")

    # Test 1: Initial count should be 0
    text1 = Selenium.text(driver, "[data-testid='count']")
    t1 = runTest("Initial count should be 0", text1, "Count: 0")

    # Test 2: Increment should increase count
    println("")
    Selenium.click(driver, "[data-testid='increment']")
    sleep(300)
    text2 = Selenium.text(driver, "[data-testid='count']")
    t2 = runTest("After increment", text2, "Count: 1")

    # Test 3: Multiple increments
    println("")
    Selenium.click(driver, "[data-testid='increment']")
    sleep(200)
    Selenium.click(driver, "[data-testid='increment']")
    sleep(200)
    Selenium.click(driver, "[data-testid='increment']")
    sleep(200)
    Selenium.click(driver, "[data-testid='increment']")
    sleep(300)
    text3 = Selenium.text(driver, "[data-testid='count']")
    t3 = runTest("After 4 more increments", text3, "Count: 5")

    # Test 4: Decrement should decrease count
    println("")
    Selenium.click(driver, "[data-testid='decrement']")
    sleep(300)
    text4 = Selenium.text(driver, "[data-testid='count']")
    t4 = runTest("After decrement", text4, "Count: 4")

    # Test 5: Reset should set count to 0
    println("")
    Selenium.click(driver, "[data-testid='reset']")
    sleep(300)
    text5 = Selenium.text(driver, "[data-testid='count']")
    t5 = runTest("After reset", text5, "Count: 0")

    # Close the browser
    println("")
    println("Closing browser...")
    Selenium.close(driver)

    # Print summary
    passed = t1 + t2 + t3 + t4 + t5
    println("")
    println("=== Test Summary ===")
    println("Passed: " ++ show(passed) ++ " / 5")

    # Return 0 if all tests passed, 1 otherwise
    if passed == 5 then 0 else 1
}</code></pre>
                </div>
                <p class="text-slate-400 mb-6">
                    Running the test produces output like:
                </p>
                <div class="bg-slate-800 rounded-lg p-4 mb-8 font-mono text-sm text-green-400 overflow-x-auto">
<pre>=== Counter App Selenium Tests ===

Connecting to ChromeDriver...
Connected!
Navigating to counter app...
Page loaded!

Test: Initial count should be 0
  Got: Count: 0
  [PASS]

Test: After increment
  Got: Count: 1
  [PASS]

Test: After 4 more increments
  Got: Count: 5
  [PASS]

Test: After decrement
  Got: Count: 4
  [PASS]

Test: After reset
  Got: Count: 0
  [PASS]

Closing browser...

=== Test Summary ===
Passed: 5 / 5</pre>
                </div>

                <!-- Testing a Shopping Cart -->
                <h2 class="text-2xl font-semibold text-white mb-4">Example: Testing a Shopping Cart</h2>
                <p class="text-slate-400 mb-4">
                    Here's a more complex example testing a shopping cart with multiple items, quantities, and discounts:
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># cart_test.nos - Shopping cart integration tests

runTest(name, got, expected) = {
    println("Test: " ++ name)
    println("  Got: " ++ got)
    result = String.contains(got, expected)
    if result then println("  [PASS]") else println("  [FAIL] Expected: " ++ expected)
    if result then 1 else 0
}

main() = {
    println("=== Shopping Cart Selenium Tests ===")
    println("")

    driver = Selenium.connect("http://localhost:4444")
    Selenium.goto(driver, "http://localhost:8097")
    Selenium.waitFor(driver, "[data-testid='qty-a']", 5000)
    println("Cart app loaded!")
    println("")

    # Test 1: Initial quantity is 0
    t1 = runTest("Initial qty A",
                 Selenium.text(driver, "[data-testid='qty-a']"), "0")

    # Test 2: Add Item A twice (2 x $10 = $20)
    println("")
    Selenium.click(driver, "[data-testid='inc-a']")
    sleep(300)
    Selenium.click(driver, "[data-testid='inc-a']")
    sleep(300)
    t2 = runTest("Qty A after 2 increments",
                 Selenium.text(driver, "[data-testid='qty-a']"), "2")

    # Test 3: Check subtotal A
    println("")
    t3 = runTest("Subtotal A (2 x $10)",
                 Selenium.text(driver, "[data-testid='subtotal-a']"), "$20")

    # Test 4: Add Item B three times (3 x $25 = $75)
    println("")
    Selenium.click(driver, "[data-testid='inc-b']")
    sleep(300)
    Selenium.click(driver, "[data-testid='inc-b']")
    sleep(300)
    Selenium.click(driver, "[data-testid='inc-b']")
    sleep(300)
    t4 = runTest("Subtotal B (3 x $25)",
                 Selenium.text(driver, "[data-testid='subtotal-b']"), "$75")

    # Test 5: Check total subtotal ($20 + $75 = $95)
    println("")
    t5 = runTest("Total subtotal",
                 Selenium.text(driver, "[data-testid='subtotal']"), "$95")

    # Test 6: Apply 50% discount ($95 * 50% = $47.50, rounds to $47)
    println("")
    Selenium.click(driver, "[data-testid='discount-50']")
    sleep(500)
    t6 = runTest("Total with 50% discount",
                 Selenium.text(driver, "[data-testid='total']"), "$47")

    # Test 7: Clear cart
    println("")
    Selenium.click(driver, "[data-testid='clear-cart']")
    sleep(500)
    t7 = runTest("Subtotal after clear",
                 Selenium.text(driver, "[data-testid='subtotal']"), "$0")

    println("")
    println("Closing browser...")
    Selenium.close(driver)

    passed = t1 + t2 + t3 + t4 + t5 + t6 + t7
    println("")
    println("=== Test Summary ===")
    println("Passed: " ++ show(passed) ++ " / 7")

    if passed == 7 then 0 else 1
}</code></pre>
                </div>

                <!-- Typing Text -->
                <h2 class="text-2xl font-semibold text-white mb-4">Typing Text into Forms</h2>
                <p class="text-slate-400 mb-4">
                    Use <code class="bg-slate-800 px-2 py-1 rounded">Selenium.type</code> to enter text into input fields:
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># Example: Testing a login form
main() = {
    driver = Selenium.connect("http://localhost:4444")
    Selenium.goto(driver, "http://localhost:8080/login")
    Selenium.waitFor(driver, "input[name='email']", 5000)

    # Type into form fields
    Selenium.type(driver, "input[name='email']", "user@example.com")
    Selenium.type(driver, "input[name='password']", "secretpassword")

    # Submit the form
    Selenium.click(driver, "button[type='submit']")

    # Wait for redirect and verify login success
    Selenium.waitFor(driver, "[data-testid='welcome-message']", 5000)
    welcome = Selenium.text(driver, "[data-testid='welcome-message']")
    println("Welcome message: " ++ welcome)

    Selenium.close(driver)
    0
}</code></pre>
                </div>

                <!-- Error Handling -->
                <h2 class="text-2xl font-semibold text-white mb-4">Error Handling</h2>
                <p class="text-slate-400 mb-4">
                    Selenium operations can fail for various reasons: element not found, timeout exceeded, browser crashed, etc. You can use Nostos's error handling to deal with these situations:
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># Example with error handling
main() = {
    println("Attempting to connect to ChromeDriver...")

    result = try {
        driver = Selenium.connect("http://localhost:4444")
        Selenium.goto(driver, "http://localhost:8080")

        # Try to find an element that might not exist
        Selenium.waitFor(driver, "[data-testid='optional-element']", 2000)
        text = Selenium.text(driver, "[data-testid='optional-element']")

        Selenium.close(driver)
        Ok(text)
    } catch e {
        Err(e)
    }

    match result {
        Ok(text) -> println("Found element with text: " ++ text)
        Err(e) -> println("Error occurred: " ++ e)
    }

    0
}</code></pre>
                </div>

                <!-- Organizing Tests -->
                <h2 class="text-2xl font-semibold text-white mb-4">Organizing Your Tests</h2>
                <p class="text-slate-400 mb-4">
                    For larger test suites, organize your tests into separate files and create helper modules:
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-6 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># test_helpers.nos - Reusable test utilities

# Standard test runner with formatted output
runTest(name, got, expected) = {
    println("Test: " ++ name)
    println("  Got: " ++ got)
    result = String.contains(got, expected)
    if result then println("  [PASS]") else println("  [FAIL] Expected: " ++ expected)
    if result then 1 else 0
}

# Run a test with exact match
runExactTest(name, got, expected) = {
    println("Test: " ++ name)
    println("  Got: " ++ got)
    result = got == expected
    if result then println("  [PASS]") else println("  [FAIL] Expected exactly: " ++ expected)
    if result then 1 else 0
}

# Create a fresh browser session
withBrowser(url, testFn) = {
    driver = Selenium.connect("http://localhost:4444")
    Selenium.goto(driver, url)
    Selenium.waitFor(driver, "body", 10000)

    result = testFn(driver)

    Selenium.close(driver)
    result
}</code></pre>
                </div>
                <p class="text-slate-400 mb-4">
                    Then use the helpers in your test files:
                </p>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># login_tests.nos
use test_helpers

main() = withBrowser("http://localhost:8080", driver => {
    println("=== Login Tests ===")

    # Navigate to login page
    Selenium.click(driver, "[data-testid='login-link']")
    Selenium.waitFor(driver, "[data-testid='login-form']", 5000)

    # Test empty form submission
    Selenium.click(driver, "[data-testid='submit']")
    sleep(300)
    t1 = runTest("Shows error for empty form",
                 Selenium.text(driver, "[data-testid='error']"),
                 "Email is required")

    # Test invalid email
    Selenium.type(driver, "input[name='email']", "notanemail")
    Selenium.click(driver, "[data-testid='submit']")
    sleep(300)
    t2 = runTest("Shows error for invalid email",
                 Selenium.text(driver, "[data-testid='error']"),
                 "Invalid email format")

    println("")
    println("Passed: " ++ show(t1 + t2) ++ " / 2")

    if t1 + t2 == 2 then 0 else 1
})</code></pre>
                </div>

                <!-- Best Practices -->
                <h2 class="text-2xl font-semibold text-white mb-4">Best Practices</h2>

                <h3 class="text-xl font-semibold text-white mb-3 mt-6">1. Use Stable Selectors</h3>
                <div class="bg-nostos-code rounded-lg p-6 mb-6 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># GOOD: Stable, testing-specific selectors
Selenium.click(driver, "[data-testid='add-to-cart']")

# BAD: Brittle selectors that break with styling changes
Selenium.click(driver, "div.product-card > div.actions > button.btn-primary")
Selenium.click(driver, "button:nth-child(3)")</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-white mb-3 mt-6">2. Always Wait for Elements</h3>
                <div class="bg-nostos-code rounded-lg p-6 mb-6 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># GOOD: Wait for dynamic content
Selenium.click(driver, "[data-testid='load-data']")
Selenium.waitFor(driver, "[data-testid='data-table']", 10000)
data = Selenium.text(driver, "[data-testid='data-table']")

# BAD: Assumes content is immediately available
Selenium.click(driver, "[data-testid='load-data']")
data = Selenium.text(driver, "[data-testid='data-table']")  # Might fail!</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-white mb-3 mt-6">3. Clean Up After Tests</h3>
                <div class="bg-nostos-code rounded-lg p-6 mb-6 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># GOOD: Always close the browser, even on error
main() = {
    driver = Selenium.connect("http://localhost:4444")

    result = try {
        # ... run tests ...
        0
    } catch e {
        println("Test error: " ++ e)
        1
    }

    # Always clean up
    Selenium.close(driver)
    result
}</code></pre>
                </div>

                <h3 class="text-xl font-semibold text-white mb-3 mt-6">4. Use Meaningful Delays</h3>
                <div class="bg-nostos-code rounded-lg p-6 mb-8 border border-slate-800 overflow-x-auto">
<pre><code class="language-nostos"># GOOD: Use waitFor when possible, short sleeps for animations
Selenium.waitFor(driver, "[data-testid='modal']", 5000)
sleep(300)  # Wait for animation to complete
Selenium.click(driver, "[data-testid='modal-close']")

# BAD: Long arbitrary sleeps
sleep(5000)  # Why 5 seconds? Is this enough? Too much?</code></pre>
                </div>

                <!-- Running Tests in CI/CD -->
                <h2 class="text-2xl font-semibold text-white mb-4">Running Tests in CI/CD</h2>
                <p class="text-slate-400 mb-4">
                    To run Selenium tests in a CI/CD pipeline, you'll need ChromeDriver running in headless mode. Here's a typical setup:
                </p>
                <div class="bg-slate-800 rounded-lg p-4 mb-8 font-mono text-sm text-slate-300 overflow-x-auto">
<pre># .github/workflows/selenium-tests.yml
name: Selenium Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Chrome and ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          CHROME_VERSION=$(google-chrome --version | grep -oE '[0-9]+' | head -1)
          wget https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION -O /tmp/chromedriver_version
          wget https://chromedriver.storage.googleapis.com/$(cat /tmp/chromedriver_version)/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/

      - name: Start ChromeDriver
        run: chromedriver --port=4444 &

      - name: Start application
        run: ./nostos my_app.nos &

      - name: Wait for app to start
        run: sleep 5

      - name: Run Selenium tests
        run: ./nostos tests/selenium_tests.nos</pre>
                </div>

                <!-- Summary -->
                <h2 class="text-2xl font-semibold text-white mb-4">Summary</h2>
                <p class="text-slate-400 mb-4">
                    In this chapter, you learned how to:
                </p>
                <ul class="list-disc list-inside text-slate-400 mb-8 space-y-2">
                    <li>Set up ChromeDriver for browser automation</li>
                    <li>Connect to ChromeDriver and navigate to web pages</li>
                    <li>Find elements using CSS selectors</li>
                    <li>Wait for elements to appear on dynamic pages</li>
                    <li>Click elements, type text, and read content</li>
                    <li>Write comprehensive end-to-end tests</li>
                    <li>Organize tests and follow best practices</li>
                </ul>

                <div class="bg-blue-900/30 border border-blue-800 rounded-lg p-6 mb-8">
                    <h3 class="text-lg font-semibold text-blue-400 mb-2">Quick Reference</h3>
                    <div class="text-slate-400 font-mono text-sm">
                        <p class="mb-2"><code>Selenium.connect(url)</code> - Connect to ChromeDriver</p>
                        <p class="mb-2"><code>Selenium.goto(driver, url)</code> - Navigate to URL</p>
                        <p class="mb-2"><code>Selenium.waitFor(driver, selector, ms)</code> - Wait for element</p>
                        <p class="mb-2"><code>Selenium.click(driver, selector)</code> - Click element</p>
                        <p class="mb-2"><code>Selenium.text(driver, selector)</code> - Get element text</p>
                        <p class="mb-2"><code>Selenium.type(driver, selector, text)</code> - Type into input</p>
                        <p><code>Selenium.close(driver)</code> - Close browser</p>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex justify-between border-t border-slate-800 pt-8">
                <a href="27_logging.html" class="flex items-center text-blue-400 hover:text-blue-300 font-medium transition">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m0 0h18"></path></svg>
                    Previous: Logging
                </a>
                <span class="text-slate-600">
                    End of Tutorial
                </span>
            </div>
        </main>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="../js/nostos-highlight.js"></script>
    <script src="../js/tutorial-sidebar.js"></script>
    <script>hljs.highlightAll();</script>
</body>
</html>
