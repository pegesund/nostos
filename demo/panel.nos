# Panel Demo - A simple list panel with keyboard navigation
#
# This demonstrates mvars (module-level mutable variables) for UI state.
# The panel shows a list of items with a cursor that can be moved with Up/Down.
#
# Usage: Call panelDemo() from the REPL after loading with :demo

# Panel activation state - must call panelDemo() to activate
mvar panelActivated: Bool = false

# Key registration - the TUI checks this after each eval
mvar panelKeyBinding: String = ""

# Panel state using mvars
mvar panelCursor: Int = 0
mvar panelItems: List[String] = ["First item", "Second item", "Third item", "Fourth item", "Fifth item"]

# Get total item count
panelItemCount() = 5

# Accessor functions (leaf functions for mvar safety)
panelGetCursor() = panelCursor
panelGetItems() = panelItems

# Handle keyboard input - single entry point for all keys
# This is the Nostos-native way: pattern match on key name
panelHandleKey(key) = match key
    "up" -> panelMoveUp()
    "down" -> panelMoveDown()
    "k" -> panelMoveUp()    # vim binding
    "j" -> panelMoveDown()  # vim binding
    _ -> ()  # ignore other keys
end

# Leaf functions for mvar-safe cursor movement
panelMoveUp() = {
    if panelCursor > 0 then {
        panelCursor = panelCursor - 1
    } else {
        ()
    }
}

panelMoveDown() = {
    count = panelItemCount()
    if panelCursor < count - 1 then {
        panelCursor = panelCursor + 1
    } else {
        ()
    }
}

# Render a single item with cursor indicator
panelRenderItem(idx, item, cursor) =
    if idx == cursor then "> " ++ item else "  " ++ item

# Render the full list recursively
panelRenderList(items, idx, cursor) = match items
    [] -> ""
    [item | rest] -> panelRenderItem(idx, item, cursor) ++ "\n" ++ panelRenderList(rest, idx + 1, cursor)
end

# Main view function - returns the panel content as a string
panelView() = {
    header = "Nostos Panel Demo\n"
    header2 = "=================\n\n"
    items = panelGetItems()
    cursor = panelGetCursor()
    list = panelRenderList(items, 0, cursor)
    footer = "\n[UP/DOWN or j/k to move, Ctrl+W/ESC to close]"
    header ++ header2 ++ list ++ footer
}

# Activate the panel - must be called before Alt+T will work
activatePanel() = {
    panelActivated = true
    panelActivated
}

# Check if panel is activated
isActivated() = panelActivated

# Entry point - activates the panel and registers the keybinding
# Call this from the REPL: demo.panel.panelDemo()
panelDemo() = {
    activatePanel()
    panelKeyBinding = "alt+t"
    "Panel activated! Press Alt+T to open."
}
