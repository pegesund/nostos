# Test file IO functions

# Test basic file read/write (high-level API)
testReadWriteAll() = {
    println("Testing File.readAll and File.writeAll...")

    path = "/tmp/nostos_test_basic.txt"
    content = "Hello, Nostos File IO!"

    # Write content to file
    (status, result) = File.writeAll(path, content)
    println("Write status: " ++ status)
    assert(status == "ok")

    # Read content back
    (status2, data) = File.readAll(path)
    println("Read status: " ++ status2)
    println("Content: " ++ data)

    assert(status2 == "ok")
    assert(data == content)

    # Cleanup
    File.remove(path)
    println("Basic read/write test PASSED")
}

# Test file existence checking
testFileExists() = {
    println("")
    println("Testing File.exists...")

    path = "/tmp/nostos_test_exists.txt"

    # File should not exist yet
    (status1, exists1) = File.exists(path)
    assert(status1 == "ok")
    assert(exists1 == false)
    println("File does not exist (expected): OK")

    # Create the file
    File.writeAll(path, "test")

    # Now it should exist
    (status2, exists2) = File.exists(path)
    assert(status2 == "ok")
    assert(exists2 == true)
    println("File exists after creation: OK")

    # Cleanup
    File.remove(path)
    println("File.exists test PASSED")
}

# Test file removal
testFileRemove() = {
    println("")
    println("Testing File.remove...")

    path = "/tmp/nostos_test_remove.txt"

    # Create a file
    File.writeAll(path, "to be deleted")

    # Verify it exists
    (ok, exists1) = File.exists(path)
    assert(exists1 == true)

    # Remove it
    (status, ignore) = File.remove(path)
    assert(status == "ok")

    # Verify it's gone
    (ok, exists2) = File.exists(path)
    assert(exists2 == false)

    println("File.remove test PASSED")
}

# Test file rename
testFileRename() = {
    println("")
    println("Testing File.rename...")

    oldPath = "/tmp/nostos_test_old.txt"
    newPath = "/tmp/nostos_test_new.txt"

    # Create original file
    File.writeAll(oldPath, "rename me")

    # Rename it
    (status, ignore) = File.rename(oldPath, newPath)
    assert(status == "ok")

    # Old path should not exist
    (s, oldExists) = File.exists(oldPath)
    assert(oldExists == false)

    # New path should exist with same content
    (s, newExists) = File.exists(newPath)
    assert(newExists == true)

    (status, content) = File.readAll(newPath)
    assert(content == "rename me")

    # Cleanup
    File.remove(newPath)
    println("File.rename test PASSED")
}

# Test file copy
testFileCopy() = {
    println("")
    println("Testing File.copy...")

    srcPath = "/tmp/nostos_test_src.txt"
    destPath = "/tmp/nostos_test_dest.txt"
    content = "copy this content"

    # Create source file
    File.writeAll(srcPath, content)

    # Copy it
    (status, ignore) = File.copy(srcPath, destPath)
    assert(status == "ok")

    # Both should exist
    (s, srcExists) = File.exists(srcPath)
    (s, destExists) = File.exists(destPath)
    assert(srcExists == true)
    assert(destExists == true)

    # Content should match
    (s, destContent) = File.readAll(destPath)
    assert(destContent == content)

    # Cleanup
    File.remove(srcPath)
    File.remove(destPath)
    println("File.copy test PASSED")
}

# Test file size
testFileSize() = {
    println("")
    println("Testing File.size...")

    path = "/tmp/nostos_test_size.txt"
    content = "12345678901234567890"  # 20 bytes

    File.writeAll(path, content)

    (status, size) = File.size(path)
    assert(status == "ok")
    print("File size: ")
    println(size)
    assert(size == 20)

    # Cleanup
    File.remove(path)
    println("File.size test PASSED")
}

# Test directory creation
testDirCreate() = {
    println("")
    println("Testing Dir.create...")

    path = "/tmp/nostos_test_dir"

    # Create directory
    (status, ignore) = Dir.create(path)
    println("Dir.create status: " ++ status)

    # Check it exists
    (ok, exists) = Dir.exists(path)
    assert(exists == true)
    println("Directory exists: OK")

    # Cleanup
    Dir.remove(path)
    println("Dir.create test PASSED")
}

# Test recursive directory creation
testDirCreateAll() = {
    println("")
    println("Testing Dir.createAll...")

    path = "/tmp/nostos_test_nested/level1/level2"

    # Create nested directories
    (status, ignore) = Dir.createAll(path)
    assert(status == "ok")

    # Check it exists
    (ok, exists) = Dir.exists(path)
    assert(exists == true)

    # Cleanup (remove recursively)
    Dir.removeAll("/tmp/nostos_test_nested")
    println("Dir.createAll test PASSED")
}

# Test directory listing
testDirList() = {
    println("")
    println("Testing Dir.list...")

    basePath = "/tmp/nostos_test_list"

    # Create directory with some files
    Dir.create(basePath)
    File.writeAll(basePath ++ "/file1.txt", "one")
    File.writeAll(basePath ++ "/file2.txt", "two")
    File.writeAll(basePath ++ "/file3.txt", "three")

    # List contents
    (status, files) = Dir.list(basePath)
    assert(status == "ok")
    print("Files found: ")
    println(files)

    # Cleanup
    Dir.removeAll(basePath)
    println("Dir.list test PASSED")
}

# Test directory exists
testDirExists() = {
    println("")
    println("Testing Dir.exists...")

    path = "/tmp/nostos_test_dir_exists"

    # Should not exist
    (ok, exists1) = Dir.exists(path)
    assert(exists1 == false)

    # Create it
    Dir.create(path)

    # Now should exist
    (ok, exists2) = Dir.exists(path)
    assert(exists2 == true)

    # Cleanup
    Dir.remove(path)
    println("Dir.exists test PASSED")
}

# Test file handle operations (low-level API)
testFileHandle() = {
    println("")
    println("Testing file handle operations...")

    path = "/tmp/nostos_test_handle.txt"

    # Open for writing (mode: "w")
    (status1, handle) = File.open(path, "w")
    println("Open status: " ++ status1)
    assert(status1 == "ok")

    # Write some data
    (status2, written) = File.write(handle, "Hello from handle!")
    println("Write status: " ++ status2)
    assert(status2 == "ok")

    # Flush to ensure data is written
    (status3, r3) = File.flush(handle)
    assert(status3 == "ok")

    # Close the handle
    (status4, r4) = File.close(handle)
    assert(status4 == "ok")

    # Read back with readAll to verify
    (status, content) = File.readAll(path)
    println("Content after handle write: " ++ content)
    assert(content == "Hello from handle!")

    # Cleanup
    File.remove(path)
    println("File handle test PASSED")
}

# Test file read with handle
testFileReadHandle() = {
    println("")
    println("Testing File.read with handle...")

    path = "/tmp/nostos_test_read_handle.txt"
    content = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"

    # Create file
    File.writeAll(path, content)

    # Open for reading
    (status1, handle) = File.open(path, "r")
    assert(status1 == "ok")

    # Read first 10 bytes
    (status2, data) = File.read(handle, 10)
    assert(status2 == "ok")
    println("First 10 bytes: " ++ data)
    assert(data == "ABCDEFGHIJ")

    # Read next 10 bytes
    (status3, data2) = File.read(handle, 10)
    assert(status3 == "ok")
    println("Next 10 bytes: " ++ data2)
    assert(data2 == "KLMNOPQRST")

    # Close
    File.close(handle)

    # Cleanup
    File.remove(path)
    println("File.read with handle test PASSED")
}

# Test file readLine
testFileReadLine() = {
    println("")
    println("Testing File.readLine...")

    path = "/tmp/nostos_test_readline.txt"
    # Use actual newlines (multiline string)
    content = "Line 1
Line 2
Line 3"

    # Create file
    File.writeAll(path, content)

    # Open for reading
    (s, handle) = File.open(path, "r")

    # Read lines - note: readLine includes the newline character
    (status1, line1) = File.readLine(handle)
    print("Line 1 length: ")
    println(length(line1))

    (status2, line2) = File.readLine(handle)
    print("Line 2 length: ")
    println(length(line2))

    (status3, line3) = File.readLine(handle)
    print("Line 3 length: ")
    println(length(line3))

    # Close
    File.close(handle)

    # Cleanup
    File.remove(path)
    println("File.readLine test PASSED")
}

# Test file seek with all whence values
testFileSeek() = {
    println("")
    println("Testing File.seek...")

    path = "/tmp/nostos_test_seek.txt"
    content = "0123456789ABCDEFGHIJ"

    # Create file
    File.writeAll(path, content)

    # Open for reading
    (s, handle) = File.open(path, "r")

    # Seek to position 10 from start
    (status1, pos1) = File.seek(handle, 10, "start")
    assert(status1 == "ok")
    print("Position after seek from start: ")
    println(pos1)
    assert(pos1 == 10)

    # Read from that position
    (s, data) = File.read(handle, 5)
    println("Data at position 10: " ++ data)
    assert(data == "ABCDE")

    # Seek relative to current position (now at 15, go back 5)
    (status2, pos2) = File.seek(handle, -5, "current")
    assert(status2 == "ok")
    print("Position after seek -5 from current: ")
    println(pos2)
    assert(pos2 == 10)

    # Read again to verify
    (s, data2) = File.read(handle, 5)
    assert(data2 == "ABCDE")

    # Seek from end (go to last 5 bytes)
    (status3, pos3) = File.seek(handle, -5, "end")
    assert(status3 == "ok")
    print("Position after seek -5 from end: ")
    println(pos3)
    assert(pos3 == 15)

    (s, data3) = File.read(handle, 5)
    assert(data3 == "FGHIJ")

    # Close
    File.close(handle)

    # Cleanup
    File.remove(path)
    println("File.seek test PASSED")
}

# Test append mode
testAppendMode() = {
    println("")
    println("Testing append mode...")

    path = "/tmp/nostos_test_append.txt"

    # Create initial file
    File.writeAll(path, "Hello")

    # Open in append mode and add more
    (s1, handle) = File.open(path, "a")
    assert(s1 == "ok")
    File.write(handle, " World")
    File.close(handle)

    # Verify content
    (s2, content) = File.readAll(path)
    println("After append: " ++ content)
    assert(content == "Hello World")

    # Append more
    (s3, handle2) = File.open(path, "a")
    File.write(handle2, "!")
    File.close(handle2)

    (s4, content2) = File.readAll(path)
    println("After second append: " ++ content2)
    assert(content2 == "Hello World!")

    # Cleanup
    File.remove(path)
    println("Append mode test PASSED")
}

# Test read/write mode
testReadWriteMode() = {
    println("")
    println("Testing read/write mode...")

    path = "/tmp/nostos_test_rw.txt"

    # Create file with initial content
    File.writeAll(path, "AAAAAAAAAA")

    # Open in read/write mode and test seeking + writing
    (s1, handle) = File.open(path, "rw")
    assert(s1 == "ok")

    # Seek to position 5 explicitly
    File.seek(handle, 5, "start")

    # Write at position 5 (replacing bytes 5-9)
    File.write(handle, "BBBBB")
    File.close(handle)

    # Verify content - write should overwrite at position 5
    (s3, content) = File.readAll(path)
    println("After read/write: " ++ content)
    assert(content == "AAAAABBBBB")

    # Cleanup
    File.remove(path)
    println("Read/write mode test PASSED")
}

# Test unicode and special characters
testUnicodeStrings() = {
    println("")
    println("Testing unicode and special characters...")

    path = "/tmp/nostos_test_unicode.txt"

    # Test various unicode strings
    unicode1 = "Hello, ä¸–ç•Œ!"
    File.writeAll(path, unicode1)
    (s1, read1) = File.readAll(path)
    println("Unicode 1: " ++ read1)
    assert(read1 == unicode1)

    # Emojis
    unicode2 = "Test ðŸš€ rocket ðŸŽ‰ party"
    File.writeAll(path, unicode2)
    (s2, read2) = File.readAll(path)
    println("Unicode 2: " ++ read2)
    assert(read2 == unicode2)

    # Actual tab and newline using multiline string
    special = "Tab:	here
Newline"
    File.writeAll(path, special)
    (s3, read3) = File.readAll(path)
    assert(read3 == special)
    println("Special characters: OK")

    # Empty string
    File.writeAll(path, "")
    (s4, read4) = File.readAll(path)
    assert(read4 == "")
    println("Empty string: OK")

    # Cleanup
    File.remove(path)
    println("Unicode/special characters test PASSED")
}

# Test multiline strings
testMultilineStrings() = {
    println("")
    println("Testing multiline strings...")

    path = "/tmp/nostos_test_multiline.txt"

    # Use actual multiline string
    content = "Line 1
Line 2
Line 3

Line 5 after blank
"
    File.writeAll(path, content)

    # Read all
    (s1, read1) = File.readAll(path)
    assert(read1 == content)
    println("Multiline read: OK")

    # Read line by line
    (s2, handle) = File.open(path, "r")

    (s3, line1) = File.readLine(handle)
    # Line 1 + newline = 7 chars
    assert(length(line1) == 7)

    (s4, line2) = File.readLine(handle)
    # Line 2 + newline = 7 chars
    assert(length(line2) == 7)

    (s5, line3) = File.readLine(handle)
    # Line 3 + newline = 7 chars
    assert(length(line3) == 7)

    (s6, line4) = File.readLine(handle)
    # Empty line + newline = 1 char
    assert(length(line4) == 1)

    (s7, line5) = File.readLine(handle)
    # "Line 5 after blank" + newline = 19 chars
    assert(length(line5) == 19)

    File.close(handle)
    println("Line-by-line read: OK")

    # Cleanup
    File.remove(path)
    println("Multiline strings test PASSED")
}

# Test error handling
testErrorHandling() = {
    println("")
    println("Testing error handling...")

    # Try to read non-existent file
    (status1, result1) = File.readAll("/tmp/nostos_nonexistent_12345.txt")
    assert(status1 == "error")
    println("Read non-existent file: error (expected)")

    # Try to open non-existent file for reading
    (status2, result2) = File.open("/tmp/nostos_nonexistent_12345.txt", "r")
    assert(status2 == "error")
    println("Open non-existent file: error (expected)")

    # Try to remove non-existent file
    (status3, result3) = File.remove("/tmp/nostos_nonexistent_12345.txt")
    assert(status3 == "error")
    println("Remove non-existent file: error (expected)")

    # Try invalid directory
    (status4, result4) = Dir.list("/tmp/nostos_nonexistent_dir_12345")
    assert(status4 == "error")
    println("List non-existent dir: error (expected)")

    println("Error handling test PASSED")
}

# Helper for building large strings
buildLargeString(0, acc) = acc
buildLargeString(n, acc) = buildLargeString(n - 1, acc ++ "X")

# Test large strings
testLargeStrings() = {
    println("")
    println("Testing large strings...")

    path = "/tmp/nostos_test_large.txt"

    large = buildLargeString(10000, "")
    File.writeAll(path, large)

    (s1, size) = File.size(path)
    print("Large file size: ")
    println(size)
    assert(size == 10000)

    (s2, content) = File.readAll(path)
    assert(length(content) == 10000)
    println("Large string read: OK")

    # Cleanup
    File.remove(path)
    println("Large strings test PASSED")
}

main() = {
    println("=== File IO Tests ===")
    println("")

    # High-level operations
    testReadWriteAll()
    testFileExists()
    testFileRemove()
    testFileRename()
    testFileCopy()
    testFileSize()

    # Directory operations
    testDirCreate()
    testDirCreateAll()
    testDirList()
    testDirExists()

    # Handle-based operations
    testFileHandle()
    testFileReadHandle()
    testFileReadLine()
    testFileSeek()

    # File modes
    testAppendMode()
    testReadWriteMode()

    # String handling
    testUnicodeStrings()
    testMultilineStrings()
    testLargeStrings()

    # Error handling
    testErrorHandling()

    println("")
    println("=== All file IO tests PASSED! ===")
}
