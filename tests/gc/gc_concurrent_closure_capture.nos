# expect: 0
# GC handles closures created within spawned processes

worker(parent, n, x) = {
    # Create garbage closures in the worker
    garbage1 = y => y * 999
    garbage2 = z => z + 100

    # Do computation that would use closures if passed
    result = x + n
    parent <- result
}

main() = {
    me = self()

    # Spawn workers that create closures internally
    spawn { worker(me, 5, 100) }
    spawn { worker(me, 10, 100) }
    spawn { worker(me, 20, 100) }

    # Collect results
    var total = 0
    for i = 0 to 3 {
        total = receive
            r -> total + r
        end
    }

    # 105 + 110 + 120 = 335
    assert_eq(335, total)
    0
}
