# expect: ()
# GC handles recursive computation across processes with garbage

fib_with_garbage(0) = 0
fib_with_garbage(1) = 1
fib_with_garbage(n) = {
    garbage = [n, n - 1, n - 2]
    fib_with_garbage(n - 1) + fib_with_garbage(n - 2)
}

worker(parent, n) = {
    garbage = [n * 100]
    result = fib_with_garbage(n)
    parent <- result
}

main() = {
    me = self()

    # Compute several fibonacci numbers in parallel
    spawn { worker(me, 10) }  # fib(10) = 55
    spawn { worker(me, 12) }  # fib(12) = 144
    spawn { worker(me, 8) }   # fib(8) = 21
    spawn { worker(me, 6) }   # fib(6) = 8

    # Collect results
    var total = 0
    for i = 0 to 4 {
        total = receive
            r -> total + r
        end
    }

    # 55 + 144 + 21 + 8 = 228
    assert_eq(228, total)
}
