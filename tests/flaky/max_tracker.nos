# expect: 0
# Track maximum value seen across workers

mvar max_val: Int = 0

update_max(n) = {
    if n > max_val then {
        max_val = n
        true
    } else {
        false
    }
}

get_max() = max_val

check_values(vals) = match vals
    [] -> ()
    [v | rest] -> {
        update_max(v)
        check_values(rest)
    }
end

worker(parent, vals) = {
    check_values(vals)
    parent <- true
}

main() = {
    me = self()

    # Each worker checks different values
    spawn { worker(me, [50, 30, 70]) }
    spawn { worker(me, [40, 20, 60]) }
    spawn { worker(me, [35, 95, 45]) }  # Contains the maximum: 95
    spawn { worker(me, [10, 5, 80]) }

    # Wait for all
    receive _ -> () end
    receive _ -> () end
    receive _ -> () end
    receive _ -> () end

    # Maximum should be 95
    assert_eq(95, get_max())
    0
}
