# expect: 102334155
# Memoization decorator with cache helper functions
# Demonstrates: templates, UFC with mvars, thread-safe caching

# Thread-safe cache using mvar (handles concurrent access automatically)
mvar cache: Map[Int, Int] = %{}

# Cache helper functions using UFC
getCache(key: Int) -> Int =
    if cache.contains(key) { cache.get(key) } else { 0 }

setCache(key: Int, value: Int) -> Int = {
    cache.update(c => c.insert(key, value))
    value
}

hasCache(key: Int) -> Bool = cache.contains(key)

# The memoize decorator uses the cache functions
template memoize(fn) = quote {
    key = ~toVar(fn.params[0].name)
    if hasCache(key) { getCache(key) }
    else { setCache(key, ~fn.body) }
}

@memoize
fib(n: Int) -> Int = if n < 2 { n } else { fib(n - 1) + fib(n - 2) }

main() = fib(40)
