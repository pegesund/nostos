# expect: ()
# Multiple spawned processes incrementing a shared counter
# Tests atomicity of mvar operations

mvar counter: Int = 0

increment() = {
    counter = counter + 1
    counter
}

do_increments(n) = if n <= 0 then () else {
    increment()
    do_increments(n - 1)
}

worker(parent, n) = {
    do_increments(n)
    parent <- true
}

main() = {
    me = self()

    # Spawn 4 workers, each incrementing 25 times
    spawn { worker(me, 25) }
    spawn { worker(me, 25) }
    spawn { worker(me, 25) }
    spawn { worker(me, 25) }

    # Wait for all workers
    receive _ -> () end
    receive _ -> () end
    receive _ -> () end
    receive _ -> () end

    # Counter should be exactly 100 if locking works
    assert_eq(100, increment() - 1)  # increment returns new value, so subtract 1
}
