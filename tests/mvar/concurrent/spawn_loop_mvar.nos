# expect: 0
# Test spawning processes in a loop where each accesses MVars

mvar total: Int = 0
mvar worker_count: Int = 0

register_worker() = {
    worker_count = worker_count + 1
    worker_count
}

add_to_total(n) = {
    total = total + n
    total
}

worker(parent, value) = {
    register_worker()
    add_to_total(value)
    parent <- value
}

# Spawn n workers with values 1..n
spawn_workers(parent, n) = spawn_workers_helper(parent, n, n)

spawn_workers_helper(parent, n, remaining) =
    if remaining <= 0 then ()
    else {
        spawn { worker(parent, remaining) }
        spawn_workers_helper(parent, n, remaining - 1)
    }

# Wait for n messages
wait_for_workers(n) = if n <= 0 then () else {
    receive _ -> () end
    wait_for_workers(n - 1)
}

main() = {
    me = self()
    n = 15

    # Spawn 15 workers
    spawn_workers(me, n)

    # Wait for all
    wait_for_workers(n)

    # Total should be 1 + 2 + ... + 15 = 120
    assert_eq(120, total)
    assert_eq(15, worker_count)
    0
}
