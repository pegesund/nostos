# expect: 0
# Test passing maps with complex values between processes

type Person = { name: String, age: Int }

worker(parent) = {
    receive { map -> {
        # Verify the received map has correct values
        person1 = Map.get(map, "person1")
        assert_eq("Bob", person1.name)
        assert_eq(25, person1.age)

        person2 = Map.get(map, "person2")
        assert_eq("Alice", person2.name)
        assert_eq(30, person2.age)

        # Add more data and send back
        updated = Map.insert(map, "person3", Person("Eve", 35))
        updated2 = Map.insert(updated, "person4", Person("Charlie", 40))
        parent <- updated2
    } }
}

main() = {
    me = self()
    child = spawn { worker(me) }

    # Create map with complex values (homogeneous - all Person)
    map = %{
        "person1": Person("Bob", 25),
        "person2": Person("Alice", 30)
    }

    # Send to worker
    child <- map

    # Receive updated map
    result = receive { m -> m }

    # Verify original values still present
    person1 = Map.get(result, "person1")
    assert_eq("Bob", person1.name)

    # Verify new values added by worker
    person3 = Map.get(result, "person3")
    assert_eq("Eve", person3.name)
    assert_eq(35, person3.age)

    person4 = Map.get(result, "person4")
    assert_eq("Charlie", person4.name)
    assert_eq(40, person4.age)

    assert_eq(4, Map.size(result))

    0
}
