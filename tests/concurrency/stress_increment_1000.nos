# expect: 0
# Stress test: 1000 processes each incrementing a counter
# Tests that mvar function-level locking works correctly at scale

mvar counter: Int = 0

# This function reads AND writes counter, so compiler auto-generates locks
increment() = {
    counter = counter + 1
}

# Spawn n worker processes that each increment the counter
spawn_workers(parent, n: Int) = if n <= 0 then () else {
    spawn {
        increment()
        parent <- true
    }
    spawn_workers(parent, n - 1)
}

# Wait for n completion messages
wait_for(n: Int) = if n <= 0 then () else {
    receive _ -> () end
    wait_for(n - 1)
}

main() = {
    me = self()

    # Spawn 1000 workers, each increments once
    spawn_workers(me, 1000)

    # Wait for all to complete
    wait_for(1000)

    # Verify counter is exactly 1000
    assert_eq(1000, counter)
    0
}
