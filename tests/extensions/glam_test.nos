# Test file for glam extension using __native__
# NOTE: This requires the glam extension to be loaded at VM startup
# Run with: nostos --extension extensions/glam/target/release/libnostos_glam.so tests/extensions/glam_test.nos

# Helper to compare floats with tolerance
approxEq(a: Float, b: Float) = {
    diff = if a > b then a - b else b - a
    diff < 0.0001
}

# Test Vec3 operations
testVec3() = {
    # Create vectors
    v1 = __native__("Glam.vec3", 1.0, 2.0, 3.0)
    v2 = __native__("Glam.vec3", 4.0, 5.0, 6.0)

    # Test addition: (1,2,3) + (4,5,6) = (5,7,9)
    sum = __native__("Glam.vec3Add", v1, v2)
    (sx, sy, sz) = sum
    assert(approxEq(sx, 5.0))
    assert(approxEq(sy, 7.0))
    assert(approxEq(sz, 9.0))

    # Test subtraction: (4,5,6) - (1,2,3) = (3,3,3)
    diff = __native__("Glam.vec3Sub", v2, v1)
    (dx, dy, dz) = diff
    assert(approxEq(dx, 3.0))
    assert(approxEq(dy, 3.0))
    assert(approxEq(dz, 3.0))

    # Test dot product: 1*4 + 2*5 + 3*6 = 32
    dot = __native__("Glam.vec3Dot", v1, v2)
    assert(approxEq(dot, 32.0))

    # Test cross product: (1,2,3) x (4,5,6) = (-3, 6, -3)
    cross = __native__("Glam.vec3Cross", v1, v2)
    (cx, cy, cz) = cross
    assert(approxEq(cx, -3.0))
    assert(approxEq(cy, 6.0))
    assert(approxEq(cz, -3.0))

    # Test length: |(1,2,3)| = sqrt(14) â‰ˆ 3.7417
    len = __native__("Glam.vec3Length", v1)
    assert(approxEq(len, 3.7417))

    # Test scalar multiplication: (1,2,3) * 2 = (2,4,6)
    scaled = __native__("Glam.vec3Mul", v1, 2.0)
    (mx, my, mz) = scaled
    assert(approxEq(mx, 2.0))
    assert(approxEq(my, 4.0))
    assert(approxEq(mz, 6.0))

    println("Vec3 tests passed!")
    true
}

# Test Vec2 operations
testVec2() = {
    v1 = __native__("Glam.vec2", 3.0, 4.0)
    v2 = __native__("Glam.vec2", 1.0, 2.0)

    # Test addition
    sum = __native__("Glam.vec2Add", v1, v2)
    (sx, sy) = sum
    assert(approxEq(sx, 4.0))
    assert(approxEq(sy, 6.0))

    # Test length: |(3,4)| = 5
    len = __native__("Glam.vec2Length", v1)
    assert(approxEq(len, 5.0))

    # Test normalize: (3,4)/5 = (0.6, 0.8)
    norm = __native__("Glam.vec2Normalize", v1)
    (nx, ny) = norm
    assert(approxEq(nx, 0.6))
    assert(approxEq(ny, 0.8))

    println("Vec2 tests passed!")
    true
}

# Test Mat4 operations
testMat4() = {
    # Identity matrix
    identity = __native__("Glam.mat4Identity")
    assert(length(identity) == 16)

    # First element should be 1.0 (top-left of identity)
    assert(approxEq(nth(identity, 0), 1.0))
    # Fifth element should be 1.0 (second diagonal)
    assert(approxEq(nth(identity, 5), 1.0))

    # Translation matrix
    trans = __native__("Glam.mat4Translate", (10.0, 20.0, 30.0))
    # Translation is stored in elements 12, 13, 14 (column 4)
    assert(approxEq(nth(trans, 12), 10.0))
    assert(approxEq(nth(trans, 13), 20.0))
    assert(approxEq(nth(trans, 14), 30.0))

    # Scale matrix
    scale = __native__("Glam.mat4Scale", (2.0, 3.0, 4.0))
    assert(approxEq(nth(scale, 0), 2.0))  # x scale
    assert(approxEq(nth(scale, 5), 3.0))  # y scale
    assert(approxEq(nth(scale, 10), 4.0)) # z scale

    # Matrix-vector multiplication: identity * vec = vec
    vec = __native__("Glam.vec4", 1.0, 2.0, 3.0, 1.0)
    result = __native__("Glam.mat4MulVec4", identity, vec)
    (rx, ry, rz, rw) = result
    assert(approxEq(rx, 1.0))
    assert(approxEq(ry, 2.0))
    assert(approxEq(rz, 3.0))
    assert(approxEq(rw, 1.0))

    println("Mat4 tests passed!")
    true
}

# Test quaternion operations
testQuat() = {
    # Create quaternion from axis-angle (rotate 90 degrees around Z axis)
    pi = 3.14159265359
    axis = __native__("Glam.vec3", 0.0, 0.0, 1.0)
    quat = __native__("Glam.quatFromAxisAngle", axis, pi / 2.0)

    # Rotate point (1, 0, 0) by 90 degrees around Z should give (0, 1, 0)
    point = __native__("Glam.vec3", 1.0, 0.0, 0.0)
    rotated = __native__("Glam.quatRotateVec3", quat, point)
    (rx, ry, rz) = rotated
    assert(approxEq(rx, 0.0))
    assert(approxEq(ry, 1.0))
    assert(approxEq(rz, 0.0))

    println("Quaternion tests passed!")
    true
}

# Run all tests
main() = {
    println("Running glam extension tests...")

    testVec3()
    testVec2()
    testMat4()
    testQuat()

    println("All glam tests passed!")
    0
}
