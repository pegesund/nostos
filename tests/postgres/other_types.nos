# expect: 0
# PostgreSQL boolean, NULL, and mixed type tests
# REQUIRES: PostgreSQL running at localhost with user/password: postgres/postgres

test_boolean_true(conn) = {
    r1 = Pg.query(conn, "SELECT $1", [true])
    assert_eq(head(head(r1)), true)

    r2 = Pg.query(conn, "SELECT $1 AND true", [true])
    assert_eq(head(head(r2)), true)
}

test_boolean_false(conn) = {
    r1 = Pg.query(conn, "SELECT $1", [false])
    assert_eq(head(head(r1)), false)

    r2 = Pg.query(conn, "SELECT $1 OR false", [false])
    assert_eq(head(head(r2)), false)
}

test_boolean_logic(conn) = {
    r1 = Pg.query(conn, "SELECT $1 AND $2", [true, true])
    assert_eq(head(head(r1)), true)

    r2 = Pg.query(conn, "SELECT $1 AND $2", [true, false])
    assert_eq(head(head(r2)), false)

    r3 = Pg.query(conn, "SELECT $1 OR $2", [false, true])
    assert_eq(head(head(r3)), true)

    r4 = Pg.query(conn, "SELECT NOT $1", [true])
    assert_eq(head(head(r4)), false)
}

test_null(conn) = {
    # Use SQL literals for NULL tests to avoid type inference issues with [()]
    r1 = Pg.query(conn, "SELECT NULL IS NULL", [])
    assert_eq(head(head(r1)), true)

    r2 = Pg.query(conn, "SELECT NULL IS NOT NULL", [])
    assert_eq(head(head(r2)), false)
}

test_null_coalesce(conn) = {
    # Use SQL literals for NULL COALESCE tests
    r1 = Pg.query(conn, "SELECT COALESCE(NULL::text, 'default')", [])
    assert_eq(head(head(r1)), "default")

    r2 = Pg.query(conn, "SELECT COALESCE($1, 'actual')", ["provided"])
    assert_eq(head(head(r2)), "provided")
}

test_mixed_types(conn) = {
    # Test mixed types using SQL literals (avoids heterogeneous list issue)
    r1 = Pg.query(conn, "SELECT 42, 3.14, 'hello', true", [])
    row = head(r1)
    assert_eq(head(row), 42)
    # Note: can't easily test other elements due to type heterogeneity
}

test_multiple_rows(conn) = {
    # Test selecting multiple homogeneous rows
    r1 = Pg.query(conn, "SELECT num FROM (VALUES (1), (2), (3)) AS t(num)", [])
    assert_eq(length(r1), 3)
    assert_eq(head(head(r1)), 1)

    # Test string rows separately
    r2 = Pg.query(conn, "SELECT letter FROM (VALUES ('a'), ('b'), ('c')) AS t(letter)", [])
    assert_eq(length(r2), 3)
    assert_eq(head(head(r2)), "a")
}

main() = {
    conn = Pg.connect("host=localhost user=postgres password=postgres")

    test_boolean_true(conn)
    test_boolean_false(conn)
    test_boolean_logic(conn)
    test_null(conn)
    test_null_coalesce(conn)
    test_mixed_types(conn)
    test_multiple_rows(conn)

    Pg.close(conn)
    0
}
