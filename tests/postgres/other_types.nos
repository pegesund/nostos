# expect: 0
# PostgreSQL boolean, NULL, and mixed type tests
# REQUIRES: PostgreSQL running at localhost with user/password: postgres/postgres

test_boolean_true(conn) = {
    r1 = Pg.query(conn, "SELECT $1", [true])
    assert_eq(head(r1).0, true)

    r2 = Pg.query(conn, "SELECT $1 AND true", [true])
    assert_eq(head(r2).0, true)
}

test_boolean_false(conn) = {
    r1 = Pg.query(conn, "SELECT $1", [false])
    assert_eq(head(r1).0, false)

    r2 = Pg.query(conn, "SELECT $1 OR false", [false])
    assert_eq(head(r2).0, false)
}

test_boolean_logic(conn) = {
    r1 = Pg.query(conn, "SELECT $1 AND $2", [true, true])
    assert_eq(head(r1).0, true)

    r2 = Pg.query(conn, "SELECT $1 AND $2", [true, false])
    assert_eq(head(r2).0, false)

    r3 = Pg.query(conn, "SELECT $1 OR $2", [false, true])
    assert_eq(head(r3).0, true)

    r4 = Pg.query(conn, "SELECT NOT $1", [true])
    assert_eq(head(r4).0, false)
}

test_null(conn) = {
    # Use SQL literals for NULL tests to avoid type inference issues with [()]
    r1 = Pg.query(conn, "SELECT NULL IS NULL", [])
    assert_eq(head(r1).0, true)

    r2 = Pg.query(conn, "SELECT NULL IS NOT NULL", [])
    assert_eq(head(r2).0, false)
}

test_null_coalesce(conn) = {
    # Use SQL literals for NULL COALESCE tests
    r1 = Pg.query(conn, "SELECT COALESCE(NULL::text, 'default')", [])
    assert_eq(head(r1).0, "default")

    r2 = Pg.query(conn, "SELECT COALESCE($1, 'actual')", ["provided"])
    assert_eq(head(r2).0, "provided")
}

# NOTE: Heterogeneous row access is not supported by the type system.
# Pg.query returns [[a]] (list of homogeneous lists), so all columns
# in a row must have the same type. Use separate queries for different types.
# test_mixed_types(conn) = {
#     r1 = Pg.query(conn, "SELECT 42, 3.14::float8, 'hello', true", [])
#     row = head(r1)
#     assert_eq(row.0, 42)
#     assert(row.1 > 3.0)
#     assert(row.1 < 3.2)
#     assert_eq(row.2, "hello")
#     assert_eq(row.3, true)
# }

test_multiple_rows(conn) = {
    # Test selecting multiple homogeneous rows
    r1 = Pg.query(conn, "SELECT num FROM (VALUES (1), (2), (3)) AS t(num)", [])
    assert_eq(length(r1), 3)
    assert_eq(head(r1).0, 1)

    # Test string rows separately
    r2 = Pg.query(conn, "SELECT letter FROM (VALUES ('a'), ('b'), ('c')) AS t(letter)", [])
    assert_eq(length(r2), 3)
    assert_eq(head(r2).0, "a")
}

main() = {
    conn = Pg.connect("host=localhost user=postgres password=postgres")

    test_boolean_true(conn)
    test_boolean_false(conn)
    test_boolean_logic(conn)
    test_null(conn)
    test_null_coalesce(conn)
    # test_mixed_types(conn)  # Disabled: heterogeneous rows not supported by type system
    test_multiple_rows(conn)

    Pg.close(conn)
    0
}
