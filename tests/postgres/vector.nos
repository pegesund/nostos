# expect: 0
# PostgreSQL pgvector type tests
# REQUIRES: PostgreSQL running at localhost with user/password: postgres/postgres
# REQUIRES: pgvector extension installed (CREATE EXTENSION IF NOT EXISTS vector)

# Test inserting and selecting vectors
test_vector_basic(conn) = {
    # Create extension and table
    Pg.execute(conn, "CREATE EXTENSION IF NOT EXISTS vector", [])
    Pg.execute(conn, "DROP TABLE IF EXISTS test_vectors", [])
    Pg.execute(conn, "CREATE TABLE test_vectors (id SERIAL PRIMARY KEY, embedding vector(3))", [])

    # Insert a vector using Float32Array (pgvector uses 32-bit floats)
    vec = Float32Array.fromList([1.0, 2.0, 3.0])
    Pg.execute(conn, "INSERT INTO test_vectors (embedding) VALUES ($1)", [vec])

    # Select and verify
    rows = Pg.query(conn, "SELECT embedding FROM test_vectors", [])
    result = head(head(rows))

    # Result should be a Float32Array
    println("Vector result type: " ++ typeOf(result))
    println("Vector result: " ++ show(result))

    # Verify values
    assert_eq(Float32Array.length(result), 3)
}

# Test inserting vector as list of floats
test_vector_from_list(conn) = {
    Pg.execute(conn, "TRUNCATE test_vectors RESTART IDENTITY", [])

    # Insert using a list of floats
    vecList = [4.0, 5.0, 6.0]
    Pg.execute(conn, "INSERT INTO test_vectors (embedding) VALUES ($1)", [vecList])

    rows = Pg.query(conn, "SELECT embedding FROM test_vectors", [])
    result = head(head(rows))
    println("Vector from list: " ++ show(result))
    assert_eq(Float32Array.length(result), 3)
}

# Test vector similarity search
test_vector_similarity(conn) = {
    Pg.execute(conn, "TRUNCATE test_vectors RESTART IDENTITY", [])

    # Insert some test vectors
    Pg.execute(conn, "INSERT INTO test_vectors (embedding) VALUES ('[1,0,0]'::vector)", [])
    Pg.execute(conn, "INSERT INTO test_vectors (embedding) VALUES ('[0,1,0]'::vector)", [])
    Pg.execute(conn, "INSERT INTO test_vectors (embedding) VALUES ('[0,0,1]'::vector)", [])

    # Find nearest to [1,0,0]
    query = Float32Array.fromList([1.0, 0.0, 0.0])
    rows = Pg.query(conn, "SELECT id, embedding <-> $1 as distance FROM test_vectors ORDER BY distance LIMIT 1", [query])
    row = head(rows)
    id = head(row)
    distance = head(tail(row))

    println("Nearest vector ID: " ++ show(id) ++ ", distance: " ++ show(distance))
    assert_eq(id, 1)  # First vector should be nearest
}

# Test L2 distance operator
test_vector_l2_distance(conn) = {
    Pg.execute(conn, "TRUNCATE test_vectors RESTART IDENTITY", [])

    Pg.execute(conn, "INSERT INTO test_vectors (embedding) VALUES ('[3,4,0]'::vector)", [])

    # L2 distance from origin
    query = Float32Array.fromList([0.0, 0.0, 0.0])
    rows = Pg.query(conn, "SELECT embedding <-> $1 as distance FROM test_vectors", [query])
    distance = head(head(rows))

    println("L2 distance from origin: " ++ show(distance))
    # Distance should be 5 (3-4-5 triangle)
    assert(distance > 4.9 && distance < 5.1)
}

main() = {
    conn = Pg.connect("host=localhost user=postgres password=postgres")

    test_vector_basic(conn)
    test_vector_from_list(conn)
    test_vector_similarity(conn)
    test_vector_l2_distance(conn)

    # Cleanup
    Pg.execute(conn, "DROP TABLE IF EXISTS test_vectors", [])
    Pg.close(conn)

    println("All vector tests passed!")
    0
}
