# RWeb Todo App for Selenium Testing
# Tests: multiple reactive variables, filter state

use stdlib.rweb
use stdlib.rhtml

reactive Item1 = { text: String, done: Bool }
reactive Item2 = { text: String, done: Bool }
reactive Item3 = { text: String, done: Bool }
reactive Filter = { value: String }

session() = {
    item1 = Item1("", false)
    item2 = Item2("", false)
    item3 = Item3("", false)
    filter = Filter("all")

    (
        # renderPage
        () => RHtml(div([
            h1("Todo List"),

            # Stats component
            component("stats", () => RHtml(
                div([
                    span("Total: " ++ show(
                        (if item1.text != "" then 1 else 0) +
                        (if item2.text != "" then 1 else 0) +
                        (if item3.text != "" then 1 else 0)
                    ), dataTestid: "total-count"),
                    span(" | "),
                    span("Done: " ++ show(
                        (if item1.done then 1 else 0) +
                        (if item2.done then 1 else 0) +
                        (if item3.done then 1 else 0)
                    ), dataTestid: "completed-count")
                ], dataTestid: "stats")
            )),

            # Filter buttons
            div([
                button("All", dataAction: "filter-all", dataTestid: "filter-all"),
                button("Active", dataAction: "filter-active", dataTestid: "filter-active"),
                button("Done", dataAction: "filter-done", dataTestid: "filter-done")
            ]),

            # Current filter
            component("filter-display", () => RHtml(
                div("Filter: " ++ filter.value, dataTestid: "current-filter")
            )),

            # Add buttons
            div([
                button("Add Item 1", dataAction: "add-1", dataTestid: "add-1"),
                button("Add Item 2", dataAction: "add-2", dataTestid: "add-2"),
                button("Add Item 3", dataAction: "add-3", dataTestid: "add-3")
            ]),

            # Item 1 component - respects filter
            component("item1", () => RHtml({
                showItem = item1.text != "" && (filter.value == "all" || (filter.value == "done" && item1.done) || (filter.value == "active" && !item1.done))
                if showItem then
                    div([
                        span(item1.text ++ if item1.done then " [DONE]" else ""),
                        button("Toggle", dataAction: "toggle-1", dataTestid: "toggle-1"),
                        button("X", dataAction: "delete-1", dataTestid: "delete-1")
                    ], dataTestid: "item-1")
                else div([], dataTestid: "item-1-empty")
            })),

            # Item 2 component - respects filter
            component("item2", () => RHtml({
                showItem = item2.text != "" && (filter.value == "all" || (filter.value == "done" && item2.done) || (filter.value == "active" && !item2.done))
                if showItem then
                    div([
                        span(item2.text ++ if item2.done then " [DONE]" else ""),
                        button("Toggle", dataAction: "toggle-2", dataTestid: "toggle-2"),
                        button("X", dataAction: "delete-2", dataTestid: "delete-2")
                    ], dataTestid: "item-2")
                else div([], dataTestid: "item-2-empty")
            })),

            # Item 3 component - respects filter
            component("item3", () => RHtml({
                showItem = item3.text != "" && (filter.value == "all" || (filter.value == "done" && item3.done) || (filter.value == "active" && !item3.done))
                if showItem then
                    div([
                        span(item3.text ++ if item3.done then " [DONE]" else ""),
                        button("Toggle", dataAction: "toggle-3", dataTestid: "toggle-3"),
                        button("X", dataAction: "delete-3", dataTestid: "delete-3")
                    ], dataTestid: "item-3")
                else div([], dataTestid: "item-3-empty")
            }))
        ])),

        # onAction
        (action, params) => match action {
            "add-1" -> { item1.text = "Buy groceries" }
            "add-2" -> { item2.text = "Walk the dog" }
            "add-3" -> { item3.text = "Read a book" }
            "toggle-1" -> { item1.done = !item1.done }
            "toggle-2" -> { item2.done = !item2.done }
            "toggle-3" -> { item3.done = !item3.done }
            "delete-1" -> { item1.text = ""; item1.done = false }
            "delete-2" -> { item2.text = ""; item2.done = false }
            "delete-3" -> { item3.text = ""; item3.done = false }
            "filter-all" -> { filter.value = "all" }
            "filter-active" -> { filter.value = "active" }
            "filter-done" -> { filter.value = "done" }
            _ -> ()
        }
    )
}

main() = startRWeb(8096, "RWeb Todo Test", session)
