# Selenium test for RWeb counter WITHOUT components
# Verifies that the full page update fallback works correctly
#
# To run:
#   1. Start ChromeDriver: chromedriver --port=4444
#   2. Start the app: ./target/release/nostos tests-selenium/rweb_no_components_app.nos  (port 8100)
#   3. Run this test: ./target/release/nostos tests-selenium/rweb_no_components_test.nos

runTest(name, got, expected) = {
    println("Test: " ++ name)
    println("  Got: " ++ got)
    result = String.contains(got, expected)
    if result then println("  [PASS]") else println("  [FAIL] Expected: " ++ expected)
    if result then 1 else 0
}

main() = {
    println("=== RWeb No-Component Counter Test ===")
    println("Tests full page update fallback (no components)")
    println("")

    driver = Selenium.connect("http://localhost:4444")
    Selenium.goto(driver, "http://localhost:8100")
    Selenium.waitFor(driver, "[data-testid='count']", 5000)
    println("Page loaded!")
    println("")

    # Test 1: Initial value is 0
    text1 = Selenium.text(driver, "[data-testid='count']")
    t1 = runTest("Initial count should be 0", text1, "Count: 0")

    # Test 2: Increment works
    println("")
    Selenium.click(driver, "[data-testid='increment']")
    sleep(300)
    text2 = Selenium.text(driver, "[data-testid='count']")
    t2 = runTest("After increment", text2, "Count: 1")

    # Test 3: Multiple increments
    println("")
    Selenium.click(driver, "[data-testid='increment']")
    sleep(300)
    Selenium.click(driver, "[data-testid='increment']")
    sleep(300)
    text3 = Selenium.text(driver, "[data-testid='count']")
    t3 = runTest("After 2 more increments", text3, "Count: 3")

    # Test 4: Decrement works
    println("")
    Selenium.click(driver, "[data-testid='decrement']")
    sleep(300)
    text4 = Selenium.text(driver, "[data-testid='count']")
    t4 = runTest("After decrement", text4, "Count: 2")

    # Test 5: Reset works
    println("")
    Selenium.click(driver, "[data-testid='reset']")
    sleep(300)
    text5 = Selenium.text(driver, "[data-testid='count']")
    t5 = runTest("After reset", text5, "Count: 0")

    Selenium.close(driver)

    passed = t1 + t2 + t3 + t4 + t5
    println("")
    println("=== Test Summary ===")
    println("Passed: " ++ show(passed) ++ " / 5")

    if passed == 5 then 0 else 1
}
