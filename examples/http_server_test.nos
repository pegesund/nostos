# HTTP Server Test
#
# Simple HTTP server for manual testing:
# - Listens on port 8080
# - /hello returns "hello world"
# - Other paths return 404
#
# Test with: curl http://localhost:8080/hello

serverLoop(server, count) = {
  println("Waiting for request...")
  result = try {
    req = Server.accept(server)

    if req.path == "/shutdown" then {
      Server.respond(req.id, 200, [("Content-Type", "text/plain")], "Shutting down...")
      () # Exit by returning from the recursive loop
    }
    else {
      print("Request #")
      print(count)
      print(": ")
      print(req.method)
      print(" ")
      println(req.path)

      body = if req.path == "/hello" then "hello world" else "not found"
      statusCode = if req.path == "/hello" then 200 else 404

      Server.respond(req.id, statusCode, [("Content-Type", "text/plain")], body)
      serverLoop(server, count + 1)
    }
  } catch e ->
    println("Error accepting request: " ++ e)
  end
  result
}

# Send test request and then shutdown
sendTestAndShutdown() = {
  sleep(100)  # Give server time to start
  try {
    println("Client: Sending test request...")
    response = Http.get("http://localhost:8080/hello")
    println("Client: Got response with status " ++ show(response.status))
    println("Client: Sending shutdown...")
    Http.get("http://localhost:8080/shutdown")
    ()
  } catch e ->
    println("Client error: " ++ e)
  end
}

main() = {
  println("=== HTTP Server Test ===")
  println("")
  println("Starting server on http://localhost:8080")
  println("")

  result = try {
    server = Server.bind(8080)
    println("Server ready!")
    println("")

    # Spawn a client to test and then shutdown
    spawn { sendTestAndShutdown() }

    serverLoop(server, 1)

    # Clean up
    Server.close(server)
    println("Server shutdown complete.")
  } catch e ->
    println("Error starting server: " ++ e)
  end
  result
}
